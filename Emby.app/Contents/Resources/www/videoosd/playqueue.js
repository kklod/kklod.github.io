define(["dom","focusManager","events","globalize","layoutManager","playbackManager","itemHelper","listView","emby-scroller","emby-itemscontainer","css!./playqueue","paper-icon-button-light"],function(dom,focusManager,events,globalize,layoutManager,playbackManager,itemHelper,listView){"use strict";function isValidForPlaylist(i){return i.Id&&i.ServerId}function savePlaylist(instance){return require(["addToList"]).then(function(responses){var AddToList=responses[0];fetchPlaylistItems.call(instance).then(function(result){var serverId,items=result.Items.filter(isValidForPlaylist);items.length&&(serverId=items[0].ServerId,(new AddToList).show({items:items.map(function(i){return i.Id}),serverId:serverId,enableAddToPlayQueue:!1,defaultValue:"new",type:"Playlist"}))})})}function fetchPlaylistItems(query){if(this.empty)return renderNextItem(this,null),Promise.resolve({Items:[],TotalRecordCount:0});return playbackManager.getPlaylist(query||{},this.currentPlayer)}function renderNextItem(instance,item){var name;instance.upNextTitleElement||(instance.upNextTitleElement=instance.options.parent.querySelector(".upNextTitle")),item&&(name=itemHelper.getDisplayName(item,{})),instance.upNextTitleElement.innerHTML=name?globalize.translate("NextValue",name):""}function OsdPlayQueue(options){var parent=(this.options=options).parent;!function(parent,options){var html="";options.toggleBar&&(html+='<div class="upNextBar upNextBar-togglebar flex align-items-center">',html+='<i class="md-icon flex-shrink-zero" style="font-size:1.7em;">&#xe03d;</i>',html+='<div class="upNextTitle upNextTitle-dynamic flex-grow">',html+="</div>",html+='<button type="button" is="paper-icon-button-light" class="btnToggleOsdPlayQueue flex-shrink-zero" title="'+globalize.translate("HeaderPlayQueue")+'" aria-label="'+globalize.translate("HeaderPlayQueue")+'"><i class="md-icon btnToggleOsdPlayQueue-icon">&#xe5ce;</i></button>',html+="</div>",html+='<div class="upNextBar upNextBar-static flex align-items-center">',html+='<h3 class="upNextTitle upNextTitle-static flex-grow">',html+=globalize.translate("HeaderPlayQueue"),html+="</h3>",html+='<button type="button" is="paper-icon-button-light" class="btnSavePlaylist flex-shrink-zero" title="'+globalize.translate("HeaderSavePlaylist")+'" aria-label="'+globalize.translate("HeaderSavePlaylist")+'"><i class="md-icon">&#xe161;</i></button>',html+="</div>"),html+='<div is="emby-scroller" class="flex flex-grow osdPlaylist-scroller osdPlaylist osdPlaylist-hidden" data-mousewheel="true" data-horizontal="false" data-centerfocus="true">',html+='<div is="emby-itemscontainer" class="scrollSlider flex-grow flex-direction-column vertical-list itemsContainer osdPlaylistItemsContainer" data-skipplaycommands="true" data-dragreorder="true" data-virtualscrolllayout="vertical-grid">',html+="</div>",html+="</div>",parent.innerHTML=html}(parent,options),this.playlistElement=parent.querySelector(".osdPlaylist"),this.itemsContainer=parent.querySelector(".itemsContainer"),this.itemsContainer.fetchData=fetchPlaylistItems.bind(this),this.itemsContainer.getListOptions=function(items){return{renderer:listView,options:{smallIcon:!0,action:"setplaylistindex",playAction:"setplaylistindex",enableUserDataButtons:!1,mediaInfo:!1,moreButton:!1,rightButtons:[{icon:"&#xE15C;",title:globalize.translate("Remove"),id:"remove"}],dragHandle:!layoutManager.tv,multiSelect:!1,playQueueIndicator:!0},virtualScrollLayout:"vertical-list"}}.bind(this),this.itemsContainer.afterRefresh=function(){var instance,index=playbackManager.getCurrentPlaylistIndex(this.currentPlayer);-1!==index?fetchPlaylistItems.call(instance=this,{StartIndex:index+1,Limit:1}).then(function(result){renderNextItem(instance,result.Items[0])}):renderNextItem(this,null)}.bind(this),this.itemsContainer.scrollResizeObserver=!0,this.toggleIcon=parent.querySelector(".btnToggleOsdPlayQueue-icon"),parent.querySelector(".upNextBar-togglebar").addEventListener("click",function(e){e.target.closest(".btnSavePlaylist")?savePlaylist(this):this.togglePlaylist()}.bind(this)),parent.querySelector(".upNextBar-static").addEventListener("click",function(e){e.target.closest(".btnSavePlaylist")&&savePlaylist(this)}.bind(this)),this.itemsContainer.addEventListener("action-remove",function(e){playbackManager.removeFromPlaylist([e.detail.playlistItemId],this.currentPlayer)}.bind(this)),this.itemsContainer.addEventListener("itemdrop",function(e){var newIndex=e.detail.newIndex,playlistItemId=e.detail.playlistItemId;playbackManager.movePlaylistItem(playlistItemId,newIndex,this.currentPlayer)}.bind(this)),this.playlistElement.addEventListener(dom.whichTransitionEvent(),onPlaylistTransitionComplete)}function onPlaylistTransitionComplete(e){var elem=e.target;elem===e.currentTarget&&elem.classList.contains("osdPlaylist-hidden")&&elem.classList.add("hide")}return OsdPlayQueue.prototype.showPlaylist=function(){var elem=this.playlistElement;elem.classList.remove("hide"),this.toggleIcon.innerHTML="&#xe5cf;",elem.offsetWidth,elem.classList.remove("osdPlaylist-hidden"),this.options.parent.classList.add("osdPlayQueue-expanded"),setTimeout(this.scrollCurrentTrackToTop.bind(this),200),this.playlistExpanded=!0,events.trigger(this,"playlistexpanded")},OsdPlayQueue.prototype.scrollCurrentTrackToTop=function(){var itemsContainer,index=playbackManager.getCurrentPlaylistIndex(this.currentPlayer);-1===index||(itemsContainer=this.playlistElement.querySelector(".itemsContainer"))&&itemsContainer.scrollToIndex(index,{behavior:"instant"},!1)},OsdPlayQueue.prototype.setPausedState=function(paused){var elem=this.playlistElement.querySelector(".playlistIndexIndicatorImage");elem&&(paused?elem.classList.add("playlistIndexIndicatorImage-paused"):elem.classList.remove("playlistIndexIndicatorImage-paused"))},OsdPlayQueue.prototype.hidePlaylist=function(){this.playlistElement.classList.add("osdPlaylist-hidden"),this.toggleIcon.innerHTML="&#xe5ce;",this.options.parent.classList.remove("osdPlayQueue-expanded"),this.playlistExpanded=!1,events.trigger(this,"playlistcollapsed")},OsdPlayQueue.prototype.togglePlaylist=function(){this.playlistExpanded?this.hidePlaylist():this.showPlaylist()},OsdPlayQueue.prototype.updatePlaylist=function(player,playlistItemId,playlistIndex,playlistLength){this.currentPlayer=player;var parent=this.options.parent;playlistLength?(this.empty=!1,this.refreshItems(),parent.classList.remove("hide")):(parent.classList.add("hide"),this.empty=!0,this.refreshItems()),1<playlistLength?parent.classList.remove("osdPlayQueue-singletrack"):parent.classList.add("osdPlayQueue-singletrack")},OsdPlayQueue.prototype.onPlaybackStopped=function(){this.empty=!0,this.refreshItems()},OsdPlayQueue.prototype.refreshItems=function(){this.itemsContainer.refreshItems?this.itemsContainer.refreshItems():setTimeout(this.refreshItems.bind(this),100)},OsdPlayQueue.prototype.onPlaylistItemMoved=function(player,e,info){this.itemsContainer.refreshItems()},OsdPlayQueue.prototype.onPlaylistItemRemoved=function(player,e,info){this.itemsContainer.refreshItems()},OsdPlayQueue.prototype.onInputCommand=function(e){return!(!this.playlistExpanded||"back"!==e.detail.command||focusManager.hasExclusiveFocusScope())&&(this.hidePlaylist(),e.preventDefault(),!0)},OsdPlayQueue.prototype.pause=function(){this.itemsContainer.pause()},OsdPlayQueue.prototype.resume=function(options){return this.itemsContainer.resume(options)},OsdPlayQueue.prototype.setBackdropItems=function(items){},OsdPlayQueue.prototype.destroy=function(){var parent,options=this.options;!options||(parent=options.parent)&&(parent.innerHTML="",parent.classList.add("hide")),this.options=null,this.currentPlayer=null,this.upNextTitleElement=null,this.itemsContainer=null,this.playlistElement=null,this.toggleIcon=null},OsdPlayQueue});