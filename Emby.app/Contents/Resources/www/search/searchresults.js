define(["itemHelper","layoutManager","loading","globalize","connectionManager","cardBuilder","appRouter","emby-scroller","emby-itemscontainer","emby-linkbutton"],function(itemHelper,layoutManager,loading,globalize,connectionManager,cardBuilder,appRouter){"use strict";function getCardOptionsForType(type,items){if("BoxSet"===type||"Playlist"===type||"Game"===type||"Book"===type||"PhotoAlbum"===type||"MusicArtist"===type||"Person"===type)return{shape:"autooverflow",fields:["Name"],overlayText:!1,centerText:!0};if("Movie"===type||"Trailer"===type||"Series"===type)return{shape:"autooverflow",fields:["Name","ProductionYear"],overlayText:!1,centerText:!0};if("Photo"===type)return{shape:"autooverflow",fields:["Name"],overlayText:!1,centerText:!0,showParentTitle:!1};if("Audio"===type)return{shape:"autooverflow",showParentTitle:!0,preferArtistTitle:!0,fields:["Name"],overlayText:!1,centerText:!0,action:"play",sideFooter:!0};if("TvChannel"===type)return{shape:"autooverflow",showParentTitle:!1,fields:["Name","CurrentProgramParentName","CurrentProgramTime"],overlayText:!1,centerText:!0,defaultBackground:!0};if("Program"!==type)return"Tag"===type?{shape:"autooverflow",fields:["Name"],defaultBackground:!0,multiSelect:!1}:{shape:"autooverflow",fields:["Name"],overlayText:!1,centerText:!0,showParentTitle:!0};var options={shape:"autooverflow",showParentTitle:!0,fields:["Name"],centerText:!0,overlayText:!1,showAirTime:!0,showAirDateTime:!0};return function(options,type,items){if("Program"!==type)return;if(!items.length||!items[0].AsSeries)return;options.progress=!1,options.showAirTime=!1,options.showAirDateTime=!1,options.showParentTitle=!1,options.fields=options.fields.filter(isNotName),options.fields.push("ParentNameOrName")}(options,type,items),options}function isNotName(n){return"Name"!==n}function renderSearchTypes(instance,apiClient,context,value,types){var searchCategories=context.querySelector(".searchCategories");searchCategories.innerHTML="";for(var promises=[],i=0,length=types.length;i<length;i++){var type=(type=types[i]).Name||type,elem=document.createElement("div");elem.className="hide verticalSection albumResults focusable","Audio"===type&&elem.classList.add("verticalSection-extrabottompadding");var innerHTML='<h2 class="sectionTitle sectionTitle-cards focuscontainer-x padded-left padded-right">'+itemHelper.getPluralItemTypeName(type)+"</h2>";innerHTML+='<div is="emby-scroller" data-horizontal="true" data-centerfocus="card" data-mousewheel="false" class="padded-top-focusscale padded-bottom-focusscale">';var itemsContainerClass="focuscontainer-x padded-left padded-right itemsContainer scrollSlider";"Audio"===type&&(itemsContainerClass+=" itemsContainer-sideFooters"),innerHTML+='<div is="emby-itemscontainer" class="'+itemsContainerClass+'"></div>',innerHTML+="</div>",elem.innerHTML=innerHTML,elem.setAttribute("data-focusabletype","nearest"),searchCategories.appendChild(elem),promises.push(function(instance,apiClient,query,context,section){return query.Limit=16,query.ParentId=instance.options.parentId,function(apiClient,query){query.Recursive=!0,query.EnableTotalRecordCount=!1,query.ImageTypeLimit=1,query.Fields=getSearchFields(query.IncludeItemTypes),"Program"===query.IncludeItemTypes&&(query.GroupProgramsBySeries=!0);return apiClient.getItems(apiClient.getCurrentUserId(),query)}(apiClient,query).then(function(result){var items=result.Items||result.SearchHints,cardOptions=getCardOptionsForType(query.IncludeItemTypes,items);return populateResults(result,context,section,cardOptions)})}(instance,apiClient,{searchTerm:value,IncludeItemTypes:type},context,elem))}return Promise.all(promises)}function getSearchFields(type){var fields="PrimaryImageAspectRatio,CanDelete,BasicSyncInfo,ProductionYear,CanDelete";return type&&"Series"!==type||(fields+=",Status,EndDate"),fields}function populateResults(result,context,section,cardOptions){var items=result.Items||result.SearchHints,itemsContainer=(section="string"==typeof section?context.querySelector(section):section).querySelector(".itemsContainer");return cardBuilder.buildCards(items,Object.assign({itemsContainer:itemsContainer,parentContainer:section,shape:"autooverflow",scalable:!0,overlayText:!1,centerText:!0},cardOptions||{})),section.querySelector(".emby-scroller").scrollToBeginning(!0),items}function SearchResults(options){var elem,instance;this.options=options,elem=options.element,instance=this,elem.classList.add("searchResults"),instance.search("")}return SearchResults.prototype.search=function(value){loading.show();var apiClient=connectionManager.getApiClient(this.options.serverId),elem=this.options.element;elem.querySelector(".noResults").classList.add("hide");var searchInfo={instance:this,searchTerm:value};return function(instance,apiClient,context,value){(value||layoutManager.tv)&&context.querySelector(".searchSuggestions").classList.add("hide");var query={SearchTerm:value,Recursive:!0,EnableTotalRecordCount:!1,ImageTypeLimit:1,Limit:16,ParentId:instance.options.parentId,Fields:getSearchFields(),GroupProgramsBySeries:!0};return apiClient.getSearchResults(query).then(function(result){var subPromises=[];return subPromises.push(populateResults(result,context,context.querySelector(".globalResults"),{shape:"autooverflow",showParentTitle:!0,fields:["Name","Type","CurrentProgramParentName"],centerText:!0,overlayText:!1,showAirTime:!0,showAirDateTime:!0,lines:4})),subPromises.push(renderSearchTypes(instance,apiClient,context,value,result.ItemTypes)),Promise.all(subPromises)})}(this,apiClient,elem,value).then(function(itemsResponses){loading.hide();var hasResults,i,length,options=this.instance.options;if(options){if(itemsResponses[0].length&&(hasResults=!0),(itemsResponses=itemsResponses[1]).length)for(i=0,length=itemsResponses.length;i<length;i++)if(itemsResponses[i].length){hasResults=!0;break}var noResultsElem=options.element.querySelector(".noResults");hasResults||!this.searchTerm?noResultsElem.classList.add("hide"):(this.searchTerm.length<2?noResultsElem.innerHTML=globalize.translate("TwoSearchCharsRequired"):noResultsElem.innerHTML=globalize.translate("NoItemsMatchingFound"),noResultsElem.classList.remove("hide"))}}.bind(searchInfo),function(){loading.hide();var options=this.options;options&&options.element.querySelector(".noResults").classList.remove("hide")}.bind(this))},SearchResults.prototype.destroy=function(){var options=this.options;options&&options.element.classList.remove("searchFields"),this.options=null},SearchResults});