define(["globalize","loading","dialogHelper","dom","components/libraryoptionseditor/libraryoptionseditor","emby-toggle","emby-input","emby-select","paper-icon-button-light","listViewStyle","formDialogStyle","emby-linkbutton","flexStyles"],function(globalize,loading,dialogHelper,dom,libraryoptionseditor){"use strict";var currentResolve,hasChanges,currentOptions,pathInfos=[];function onSubmit(e){if(e.preventDefault(),e.stopPropagation(),0===pathInfos.length)return require(["alert"],function(alert){alert({text:globalize.translate("PleaseAddAtLeastOneFolder"),type:"error"})}),!1;var form=this,dlg=form.closest(".dialog");form.querySelector(".button-submit").setAttribute("disabled","disabled");var name=form.querySelector("#txtValue").value,type=form.querySelector("#selectCollectionType").value;"mixed"===type&&(type=null);var libraryOptions=libraryoptionseditor.getLibraryOptions(dlg.querySelector(".libraryOptions"));return libraryOptions.PathInfos=pathInfos,libraryOptions.ContentType=type,ApiClient.addVirtualFolder(name,type,currentOptions.refresh,libraryOptions).then(function(){hasChanges=!0,dialogHelper.close(dlg)},function(){form.querySelector(".button-submit").removeAttribute("disabled"),require(["toast"],function(toast){toast(globalize.translate("ErrorAddingMediaPathToVirtualFolder"))})}),!1}function onToggleAdvancedChange(){var dlg=this.closest(".dlg-librarycreator");libraryoptionseditor.setAdvancedVisible(dlg.querySelector(".libraryOptions"),this.checked)}function onAddButtonClick(){var dlg=this.closest(".dlg-librarycreator");require(["directorybrowser"],function(directoryBrowser){var picker=new directoryBrowser;picker.show({enableNetworkSharePath:!0,callback:function(path,networkSharePath){path&&function(page,path,networkSharePath){var pathLower=path.toLowerCase();{var pathInfo;0===pathInfos.filter(function(p){return p.Path.toLowerCase()===pathLower}).length&&(pathInfo={Path:path},networkSharePath&&(pathInfo.NetworkPath=networkSharePath),pathInfos.push(pathInfo),renderPaths(page))}}(dlg,path,networkSharePath),picker.close()}})})}function getFolderHtml(pathInfo,index){var html="";return html+='<div class="listItem listItem-border lnkPath" style="padding-left:.5em;">',html+='<div class="'+(pathInfo.NetworkPath?"listItemBody two-line listItemBody-noleftpadding":"listItemBody listItemBody-noleftpadding")+'">',html+='<div class="listItemBodyText">'+pathInfo.Path+"</div>",pathInfo.NetworkPath&&(html+='<div class="listItemBodyText listItemBodyText-secondary">'+pathInfo.NetworkPath+"</div>"),html+="</div>",html+='<button type="button" is="paper-icon-button-light"" class="listItemButton btnRemovePath" data-index="'+index+'"><i class="md-icon">remove_circle</i></button>',html+="</div>"}function renderPaths(page){var foldersHtml=pathInfos.map(getFolderHtml).join(""),folderList=page.querySelector(".folderList");(folderList.innerHTML=foldersHtml)?folderList.classList.remove("hide"):folderList.classList.add("hide")}function onRemoveClick(e){var index,locationLower,button=e.target.closest(".btnRemovePath");button&&(index=parseInt(button.getAttribute("data-index")),locationLower=pathInfos[index].Path.toLowerCase(),pathInfos=pathInfos.filter(function(p){return p.Path.toLowerCase()!==locationLower}),renderPaths(button.closest(".dlg-librarycreator")))}function onDialogClosed(){loading.hide(),currentResolve(hasChanges)}function initLibraryOptions(dlg){libraryoptionseditor.embed(dlg.querySelector(".libraryOptions")).then(function(){dlg.querySelector("#selectCollectionType").dispatchEvent(new CustomEvent("change",{})),onToggleAdvancedChange.call(dlg.querySelector(".chkAdvanced"))})}return function(){this.show=function(options){return new Promise(function(resolve,reject){currentOptions=options,currentResolve=resolve,hasChanges=!1;var xhr=new XMLHttpRequest;xhr.open("GET","components/medialibrarycreator/medialibrarycreator.template.html",!0),xhr.onload=function(e){var page,collectionTypeOptions,selectCollectionType,template=this.response,dlg=dialogHelper.createDialog({size:"medium-tall",modal:!1,removeOnClose:!0,scrollY:!1});dlg.classList.add("ui-body-a"),dlg.classList.add("background-theme-a"),dlg.classList.add("dlg-librarycreator"),dlg.classList.add("formDialog"),dlg.innerHTML=globalize.translateDocument(template),page=dlg,collectionTypeOptions=options.collectionTypeOptions,(selectCollectionType=page.querySelector("#selectCollectionType")).innerHTML=function(collectionTypeOptions){return collectionTypeOptions.filter(function(i){return!1!==i.isSelectable}).map(function(i){return'<option value="'+i.value+'">'+i.name+"</option>"}).join("")}(collectionTypeOptions),selectCollectionType.value="",selectCollectionType.addEventListener("change",function(){var value=this.value,dlg=this.closest(".dialog");libraryoptionseditor.setContentType(dlg.querySelector(".libraryOptions"),"mixed"===value?"":value),value?dlg.querySelector(".libraryOptions").classList.remove("hide"):dlg.querySelector(".libraryOptions").classList.add("hide");var name,folderOption,index=this.selectedIndex;-1!==index&&(name=this.options[index].innerHTML.replace("*","").replace("&amp;","&"),dlg.querySelector("#txtValue").value=name,folderOption=collectionTypeOptions.filter(function(i){return i.value===value})[0],dlg.querySelector(".collectionTypeFieldDescription").innerHTML=folderOption.message||"")}),page.querySelector(".btnAddFolder").addEventListener("click",onAddButtonClick),page.querySelector("form").addEventListener("submit",onSubmit),page.querySelector(".folderList").addEventListener("click",onRemoveClick),page.querySelector(".chkAdvanced").addEventListener("change",onToggleAdvancedChange),dlg.addEventListener("close",onDialogClosed),dialogHelper.open(dlg),dlg.querySelector(".btnCancel").addEventListener("click",function(){dialogHelper.close(dlg)}),pathInfos=[],renderPaths(dlg),initLibraryOptions(dlg)},xhr.send()})}}});