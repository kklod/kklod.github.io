define(["dom","jQuery","cardBuilder","material-icons","css!./metadatamanager"],function(dom,$,cardBuilder){"use strict";var selectedNodeId,itemId,nodesToLoad=[];function getNode(item,folderState,selected){var htmlName=function(item){var name=item.Name;item.Number&&(name=item.Number+" - "+name);null!=item.IndexNumber&&"Season"!==item.Type&&(name=item.IndexNumber+" - "+name);var htmlName="<div class='editorNode'>",icon=cardBuilder.getDefaultIcon(item);item.IsFolder?htmlName+='<i class="md-icon editorSidebarIcon">folder</i>':icon&&(htmlName+='<i class="md-icon editorSidebarIcon">'+icon+"</i>");item.LockData&&(htmlName+='<i class="md-icon editorSidebarIcon">lock</i>');return htmlName+=name,htmlName+="</div>"}(item),node={id:"livetv"===item.CollectionType?"livetv":item.Id,text:htmlName,state:{opened:item.IsFolder&&"open"===folderState,selected:selected},li_attr:{serveritemtype:item.Type,collectiontype:item.CollectionType}};return item.IsFolder&&(node.children=[{text:"Loading...",icon:!1}]),node.icon=!1,node.state.opened&&(node.li_attr.loadedFromServer=!0),selected&&(selectedNodeId=item.Id),node}function loadNode(page,scope,node,openItems,selectedId,currentUser,callback){var query,id=node.id;"#"!==id?"livetv"!==id?(query={ParentId:id,Fields:"Settings",IsVirtualUnaired:!1,IsMissing:!1,EnableTotalRecordCount:!1,EnableImages:!1,EnableUserData:!1},ApiClient.getItems(ApiClient.getCurrentUserId(),query).then(function(result){var nodes=result.Items.map(function(n){return getNode(n,-1===openItems.indexOf(n.Id)?"closed":"open",n.Id===selectedId)});callback.call(scope,nodes);for(var i=0,length=nodes.length;i<length;i++)nodes[i].state.opened&&nodesToLoad.push(nodes[i].id)})):function(openItems,callback){ApiClient.getLiveTvChannels({AddCurrentProgram:!1}).then(function(result){var nodes=result.Items.map(function(i){return getNode(i,-1===openItems.indexOf(i.Id)?"closed":"open",!1)});callback(nodes)})}(openItems,callback):function(scope,callback){ApiClient.getUserViews({},ApiClient.getCurrentUserId()).then(function(mediaFoldersResult){var nodes=mediaFoldersResult.Items.map(function(n){return getNode(n,"closed",!1)});callback.call(scope,nodes)})}(scope,callback)}function initializeTree(page,currentUser,openItems,selectedId){require(["jstree"],function(){!function(page,openItems,selectedId){nodesToLoad=[],selectedNodeId=null,$.jstree.destroy(),$(page.querySelector(".libraryTree")).jstree({plugins:["wholerow"],core:{check_callback:!0,data:function(node,callback){loadNode(0,this,node,openItems,selectedId,0,callback)},themes:{variant:"large"}}}).off("select_node.jstree",onNodeSelect).on("select_node.jstree",onNodeSelect).off("open_node.jstree",onNodeOpen).on("open_node.jstree",onNodeOpen).off("load_node.jstree",onNodeLoad).on("load_node.jstree",onNodeLoad)}(page,openItems,selectedId)})}function onNodeSelect(event,data){var node=data.node,eventData={id:node.id,itemType:node.li_attr.itemtype,serverItemType:node.li_attr.serveritemtype,collectionType:node.li_attr.collectiontype};"livetv"===eventData.itemType||"UserView"===eventData.serverItemType||"CollectionFolder"===eventData.serverItemType||eventData.collectionType?window.MetadataEditor&&window.MetadataEditor.setCurrentItemId(null):this.dispatchEvent(new CustomEvent("itemclicked",{detail:eventData,bubbles:!0,cancelable:!1}))}function onNodeOpen(event,data){var page=this.closest(".page"),node=data.node;node.children&&node.children&&loadNodesToLoad(page,node),node.li_attr&&"#"!==node.id&&!node.li_attr.loadedFromServer&&(node.li_attr.loadedFromServer=!0,$.jstree.reference(".libraryTree",page).load_node(node.id,loadNodeCallback))}function onNodeLoad(event,data){var page=this.closest(".page"),node=data.node;node.children&&node.children&&loadNodesToLoad(page,node),node.li_attr&&"#"!==node.id&&!node.li_attr.loadedFromServer&&(node.li_attr.loadedFromServer=!0,$.jstree.reference(".libraryTree",page).load_node(node.id,loadNodeCallback))}function loadNodesToLoad(page,node){for(var children=node.children,i=0,length=children.length;i<length;i++){var child=children[i];-1!==nodesToLoad.indexOf(child)&&(nodesToLoad=nodesToLoad.filter(function(child){return function(n){return n!==child}}(child)),$.jstree.reference(".libraryTree",page).load_node(child,loadNodeCallback))}}function loadNodeCallback(node){selectedNodeId&&node.children&&-1!==node.children.indexOf(selectedNodeId)&&setTimeout(function(){var id,elem;id=selectedNodeId,(elem=document.getElementById(id))&&elem.scrollIntoView()},500)}function getCurrentItemId(){return itemId}window.MetadataEditor={getItemPromise:function(){var currentItemId=itemId;return currentItemId?ApiClient.getItem(ApiClient.getCurrentUserId(),currentItemId):ApiClient.getRootFolder(ApiClient.getCurrentUserId())},getCurrentItemId:getCurrentItemId,setCurrentItemId:function(id){itemId=id},refresh:function(view){ApiClient.getCurrentUser().then(function(user){var id=itemId;id?ApiClient.getAncestorItems(id,user.Id).then(function(ancestors){var ids=ancestors.map(function(i){return i.Id});initializeTree(view,0,ids,id)}):initializeTree(view,0,[])})}}});