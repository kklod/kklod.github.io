define(["loading","mainTabsManager","globalize","cardBuilder","cardStyle","emby-linkbutton","emby-checkbox","emby-select","emby-scroller","emby-itemscontainer","css!./plugincatalog"],function(loading,mainTabsManager,globalize,cardBuilder){"use strict";var _availablePlugins,query={TargetSystems:"Server",IsAdult:!1,PackageType:"UserInstalled"};function getAvailablePlugins(){if(_availablePlugins)return Promise.resolve(_availablePlugins);var promise1=ApiClient.getAvailablePlugins(query),promise2=ApiClient.getInstalledPlugins();return Promise.all([promise1,promise2]).then(function(responses){var availablePlugins=responses[0];return function(availablePlugins,installedPlugins){for(var i=0,length=installedPlugins.length;i<length;i++){var installedPlugin=installedPlugins[i],availablePlugin=function(availablePlugins,installedPlugin){return availablePlugins.filter(function(ap){return(installedPlugin.Id||"").toLowerCase()===(ap.guid||"").toLowerCase()})[0]}(availablePlugins,installedPlugin);availablePlugin&&(availablePlugin.InstalledVersion=installedPlugin.Version)}}(availablePlugins,responses[1]),function(plugins,apiClient){for(var i=0,length=plugins.length;i<length;i++){var plugin=plugins[i];plugin.category=plugin.category||"General",plugin.Type="PluginCatalogItem",plugin.Id=plugin.guid,plugin.Name=plugin.name,plugin.ServerId=apiClient.serverId(),plugin.PrimaryImageAspectRatio=16/9,plugin.ImageUrl=plugin.thumbImage}}(availablePlugins,ApiClient),availablePlugins=availablePlugins.sort(function(a,b){var aName=a.category,bName=b.category;return bName<aName?1:aName<bName?-1:(aName=a.name,(bName=b.name)<aName?1:aName<bName?-1:0)}),_availablePlugins=availablePlugins})}function getCategories(plugins){var list=[];if(!plugins.length)return list;list.push({Name:globalize.translate("HeaderTopPlugins"),Id:"top"});for(var categories={},i=0,length=plugins.length;i<length;i++){var category=plugins[i].category;categories[category]||(categories[category]=!0,list.push({Name:function(category){category.replace(" ","").replace(" ","");"Channel"===category?category="Channels":"Theme"===category?category="Themes":"LiveTV"===category?category="HeaderLiveTV":"ScreenSaver"===category&&(category="HeaderScreenSavers");return globalize.translate(category)}(category),Id:category}))}return list}function getCategoryHtml(category){var html="";return html+='<div class="verticalSection focusable" data-focusabletype="nearest">',html+='<h2 class="sectionTitle sectionTitle-cards padded-left padded-left-page">'+category.Name+"</h2>",html+='<div is="emby-scroller" class="padded-top-focusscale padded-bottom-focusscale" data-mousewheel="false" data-centerfocus="true">',html+='<div is="emby-itemscontainer" class="scrollSlider focuscontainer-x padded-left padded-left-page padded-right itemsContainer" data-category="'+category.Id+'">',html+="</div>",html+="</div>",html+="</div>"}function getCategoryItems(){var category=this.getAttribute("data-category");return getAvailablePlugins().then(function(plugins){return"top"===category?function(plugins){return(plugins=plugins.slice(0).sort(function(a,b){if(a.installs>b.installs)return-1;if(b.installs>a.installs)return 1;var aName=a.name,bName=b.name;return bName<aName?1:aName<bName?-1:0}).filter(isUserInstalledPlugin)).length=Math.min(plugins.length,15),plugins}(plugins):plugins.filter(function(p){return p.category===category})})}function getCategoryListOptions(){return{renderer:cardBuilder,options:{shape:"auto",fields:["Name","InstalledVersion"],overlayText:!1,centerText:!0,overlayPlayButton:!1,cardLayout:!1,multiSelect:!1,contextMenu:!1,draggable:!1},virtualScrollLayout:"horizontal-grid"}}function onUpgraded(){this.resume({refresh:!0})}function reloadList(page){return _availablePlugins=null,loading.show(),getAvailablePlugins().then(function(availablePlugins){var categories=getCategories(availablePlugins),parentElem=page.querySelector(".pluginTiles");parentElem.innerHTML=categories.map(getCategoryHtml).join(""),categories.length?page.querySelector(".noPlugins").classList.add("hide"):page.querySelector(".noPlugins").classList.remove("hide");for(var itemsContainers=parentElem.querySelectorAll(".itemsContainer"),i=0,length=itemsContainers.length;i<length;i++){var itemsContainer=itemsContainers[i];itemsContainer.fetchData=getCategoryItems.bind(itemsContainer),itemsContainer.getListOptions=getCategoryListOptions.bind(itemsContainer),itemsContainer.resume?onUpgraded.call(itemsContainer):itemsContainer.addEventListener("upgraded",onUpgraded)}loading.hide()})}function isUserInstalledPlugin(plugin){return-1===["02528C96-F727-44D7-BE87-9EEF040758C3","0277E613-3EC0-4360-A3DE-F8AF0AABB5E9","4DCB591C-0FA2-4C5D-A7E5-DABE37164C8B","18CFFD2C-74F5-4EDE-8DAD-BE339443AFE4","C25B3C85-1880-4827-9C72-0FA74314F428","8C6DDB20-18B1-4131-9285-796179A71C0F","96FA50A4-69CE-42AC-B6A3-EF6B3388CCB7"].indexOf(plugin.guid)}function getTabs(){return[{href:"plugins",name:globalize.translate("TabMyPlugins")},{href:"plugincatalog",name:globalize.translate("TabCatalog")}]}return function(view,params){view.querySelector("#selectSystem").addEventListener("change",function(){query.TargetSystems=this.value,reloadList(view)}),view.addEventListener("viewshow",function(e){e.detail.isRestored||reloadList(view),mainTabsManager.setTabs(this,1,getTabs)})}});