define(["loading","globalize","connectionManager","apphost","dom","emby-linkbutton","emby-select","css!./addpluginpage"],function(loading,globalize,connectionManager,appHost,dom){"use strict";function renderPackage(pkg,installedPlugins,pluginSecurityInfo,page){var msg,img,currentVersionText,installedPlugin=installedPlugins.filter(function(ip){return(ip.Id||"").toLowerCase()===(pkg.guid||"").toLowerCase()})[0];!function(packageInfo,page,installedPlugin){for(var html="",i=0,length=packageInfo.versions.length;i<length;i++){var version=packageInfo.versions[i];html+='<option value="'+version.versionStr+"|"+version.classification+'">'+version.versionStr+" ("+version.classification+")</option>"}var pCurrentVersion,selectmenu=page.querySelector("#selectVersion");selectmenu.innerHTML=html,installedPlugin||((pCurrentVersion=page.querySelector("#pCurrentVersion")).classList.add("hide"),pCurrentVersion.innerHTML="");var val,packageVersion=packageInfo.versions.filter(function(current){return"Release"===current.classification})[0];(packageVersion=packageVersion||packageInfo.versions.filter(function(current){return"Beta"===current.classification})[0])&&(val=packageVersion.versionStr+"|"+packageVersion.classification,selectmenu.value=val)}(pkg,page,installedPlugin),function(packageInfo,page){for(var html="",i=0,length=Math.min(packageInfo.versions.length,10);i<length;i++){var version=packageInfo.versions[i];html+='<h2 style="margin:.5em 0;">'+version.versionStr+" ("+version.classification+")</h2>",html+='<div style="margin-bottom:1.5em;">'+version.description+"</div>"}page.querySelector("#revisionHistory").innerHTML=html}(pkg,page),page.querySelector(".pluginName").innerHTML=pkg.name,"Server"===pkg.targetSystem?(page.querySelector("#btnInstallDiv").classList.remove("hide"),page.querySelector("#nonServerMsg").classList.add("hide"),page.querySelector("#pSelectVersion").classList.remove("hide")):(page.querySelector("#btnInstallDiv").classList.add("hide"),page.querySelector("#pSelectVersion").classList.add("hide"),msg=globalize.translate("MessageInstallPluginFromApp"),page.querySelector("#nonServerMsg").innerHTML=msg,page.querySelector("#nonServerMsg").classList.remove("hide")),pkg.shortDescription?(page.querySelector("#tagline").classList.remove("hide"),page.querySelector("#tagline").innerHTML=pkg.shortDescription):page.querySelector("#tagline").classList.add("hide"),page.querySelector("#overview").innerHTML=pkg.overview||"",page.querySelector("#developer").innerHTML=pkg.owner,function(page,pkg,pluginSecurityInfo){var regStatus,expDateTime,nowTime,url;appHost.supports("externalpremium")&&(pkg.isPremium?(page.querySelector(".premiumPackage").classList.remove("hide"),regStatus="",pkg.isRegistered?(regStatus+="<p style='color:green;'>",regStatus+=globalize.translate("MessageFeatureIncludedWithSupporter")):(expDateTime=new Date(pkg.expDate).getTime())<=(nowTime=Date.now())?(regStatus+="<p style='color:red;'>",regStatus+=globalize.translate("MessageTrialExpired")):expDateTime>new Date(1970,1,1).getTime()&&(regStatus+="<p style='color:blue;'>",regStatus+=globalize.translate("MessageTrialWillExpireIn").replace("{0}",Math.round(expDateTime-nowTime)/864e5)),regStatus+="</p>",page.querySelector("#regStatus").innerHTML=regStatus,pluginSecurityInfo.IsMBSupporter?(page.querySelector(".premiumDescription").classList.add("hide"),page.querySelector(".supporterDescription").classList.add("hide"),0<pkg.price?(page.querySelector(".premiumHasPrice").classList.remove("hide"),page.querySelector("#featureId").value=pkg.featureId,page.querySelector("#featureName").value=pkg.name,page.querySelector("#amount").value=pkg.price,page.querySelector("#regPrice").innerHTML="<h3>"+globalize.translate("ValuePriceUSD").replace("{0}",pkg.price.toFixed(2))+"</h3>",page.querySelector("#ppButton").classList.add("hide"),url="https://mb3admin.com/admin/service/user/getPayPalEmail?id="+pkg.owner,fetch(url).then(function(response){return response.json()}).then(function(dev){dev.payPalEmail&&(page.querySelector("#payPalEmail").value=dev.payPalEmail,page.querySelector("#ppButton").classList.remove("hide"))})):page.querySelector(".premiumHasPrice").classList.add("hide")):(pkg.price?(page.querySelector(".premiumDescription").classList.remove("hide"),page.querySelector(".supporterDescription").classList.add("hide")):(page.querySelector(".premiumDescription").classList.add("hide"),page.querySelector(".supporterDescription").classList.remove("hide")),page.querySelector("#ppButton").classList.add("hide"))):page.querySelector(".premiumPackage").classList.add("hide"))}(page,pkg,pluginSecurityInfo),pkg.richDescUrl?(page.querySelector("#pViewWebsite").classList.remove("hide"),page.querySelector("#pViewWebsite a").setAttribute("href",pkg.richDescUrl)):page.querySelector("#pViewWebsite").classList.add("hide"),pkg.previewImage||pkg.thumbImage?(img=pkg.previewImage?pkg.previewImage:pkg.thumbImage,page.querySelector("#pPreviewImage").classList.remove("hide"),page.querySelector("#pPreviewImage").innerHTML="<img class='pluginPreviewImg' src='"+img+"' style='max-width: 100%;' />"):(page.querySelector("#pPreviewImage").classList.add("hide"),page.querySelector("#pPreviewImage").innerHTML=""),installedPlugin?(currentVersionText=globalize.translate("MessageYouHaveVersionInstalled").replace("{0}","<strong>"+installedPlugin.Version+"</strong>"),page.querySelector("#pCurrentVersion").classList.remove("hide"),page.querySelector("#pCurrentVersion").innerHTML=currentVersionText):(page.querySelector("#pCurrentVersion").classList.add("hide"),page.querySelector("#pCurrentVersion").innerHTML=""),loading.hide()}function alertText(options){require(["alert"]).then(function(responses){responses[0](options)})}function performInstallation(page,packageName,guid,updateClass,version){function alertCallback(confirmed){confirmed&&(loading.show(),page.querySelector("#btnInstall").disabled=!0,ApiClient.installPlugin(packageName,guid,updateClass,version).then(function(){loading.hide(),alertText(globalize.translate("PluginInstalledMessage"))}))}var msg,developer=page.querySelector("#developer").innerHTML.toLowerCase();"luke"!==developer&&"ebr"!==developer?(loading.hide(),msg=globalize.translate("MessagePluginInstallDisclaimer"),msg+="<br/>",msg+="<br/>",msg+=globalize.translate("PleaseConfirmPluginInstallation"),require(["confirm"],function(confirm){confirm(msg,globalize.translate("HeaderConfirmPluginInstallation")).then(function(){alertCallback(!0)},function(){alertCallback(!1)})})):alertCallback(!0)}return function(view,params){view.querySelector(".addPluginForm").addEventListener("submit",function(e){loading.show();var page=this.closest(".page"),name=params.name,guid=params.guid;return ApiClient.getInstalledPlugins().then(function(plugins){var installedPlugin=plugins.filter(function(ip){return(ip.Id||"").toLowerCase()===(guid||"").toLowerCase()})[0],vals=page.querySelector("#selectVersion").value.split("|"),version=vals[0];installedPlugin&&installedPlugin.Version===version?(loading.hide(),alertText({text:globalize.translate("MessageAlreadyInstalled"),title:globalize.translate("HeaderPluginInstallation")})):performInstallation(page,name,guid,vals[1],version)}),e.preventDefault(),e.stopPropagation(),!1}),view.addEventListener("viewshow",function(){var page=this;loading.show();var name=params.name,guid=params.guid,promise1=ApiClient.getPackageInfo(name,guid),promise2=ApiClient.getInstalledPlugins();connectionManager.getRegistrationInfo("themes",ApiClient,{viewOnly:!0}),Promise.all([promise1,promise2]).then(function(responses){connectionManager.getRegistrationInfo("themes",ApiClient,{viewOnly:!0}).then(function(){renderPackage(responses[0],responses[1],{IsMBSupporter:!0},page)},function(){renderPackage(responses[0],responses[1],{},page)})})})}});