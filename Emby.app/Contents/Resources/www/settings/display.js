define(["iapManager","apphost","datetime","appSettings","skinManager","pluginManager","focusManager","connectionManager","userSettingsBuilder","userSettings","layoutManager","globalize","loading","listViewStyle","emby-scroller","emby-select","emby-checkbox","emby-linkbutton"],function(iapManager,appHost,datetime,appSettings,skinManager,pluginManager,focusManager,connectionManager,userSettingsBuilder,currentUserSettings,layoutManager,globalize,loading){"use strict";function fillThemes(select,isSettings){for(var mainThemeValue,themes=skinManager.getThemes(),defaultFound=!1,i=0,length=themes.length;i<length;i++){var theme=themes[i],value=theme.id;(theme.isDefault&&!isSettings||theme.isSettingsDefault&&isSettings)&&(defaultFound=!(value="")),theme.value=value}isSettings&&(mainThemeValue=isSettings&&!defaultFound?"":"maintheme",themes.unshift({name:globalize.translate("SameAsMainTheme"),id:"maintheme",value:mainThemeValue,isSettingsDefault:appHost.supports("multiserver")})),select.innerHTML=themes.map(function(t){return'<option value="'+t.value+'">'+t.name+"</option>"}).join("")}function loadForm(context,user,userSettings,apiClient){apiClient.getCurrentUserId(),user.Id;appHost.supports("displaymode")?context.querySelector(".fldDisplayMode").classList.remove("hide"):context.querySelector(".fldDisplayMode").classList.add("hide"),appHost.supports("externallinks")&&appHost.supports("externalappinfo")?context.querySelector(".learnHowToContributeContainer").classList.remove("hide"):context.querySelector(".learnHowToContributeContainer").classList.add("hide"),appHost.supports("runatstartup")?context.querySelector(".fldAutorun").classList.remove("hide"):context.querySelector(".fldAutorun").classList.add("hide"),appHost.supports("soundeffects")&&layoutManager.tv?context.querySelector(".fldSoundEffects").classList.remove("hide"):context.querySelector(".fldSoundEffects").classList.add("hide"),appHost.supports("screensaver")?context.querySelector(".selectScreensaverContainer").classList.remove("hide"):context.querySelector(".selectScreensaverContainer").classList.add("hide"),datetime.supportsLocalization()?context.querySelector(".fldDateTimeLocale").classList.remove("hide"):context.querySelector(".fldDateTimeLocale").classList.add("hide"),"6da60dd6edfc4508bca2c434d4400816"!==apiClient.serverId()?(context.querySelector(".fldSeasonalThemes").classList.remove("hide"),context.querySelector(".fldBackdrops").classList.remove("hide"),context.querySelector(".fldThemeSong").classList.remove("hide"),context.querySelector(".fldThemeVideo").classList.remove("hide")):(context.querySelector(".fldSeasonalThemes").classList.add("hide"),context.querySelector(".fldBackdrops").classList.add("hide"),context.querySelector(".fldThemeSong").classList.add("hide"),context.querySelector(".fldThemeVideo").classList.add("hide")),context.querySelector(".chkRunAtStartup").checked=appSettings.runAtStartup();var selectTheme=context.querySelector(".selectTheme"),selectSettingsTheme=context.querySelector(".selectSettingsTheme");fillThemes(selectTheme),fillThemes(selectSettingsTheme,!0),function(context,userSettings){var selectScreensaver=context.querySelector(".selectScreensaver"),options=pluginManager.ofType("screensaver").map(function(plugin){return{name:plugin.name,value:plugin.id}});options.unshift({name:globalize.translate("None"),value:"none"}),selectScreensaver.innerHTML=options.map(function(o){return'<option value="'+o.value+'">'+o.name+"</option>"}).join(""),selectScreensaver.value=userSettings.screensaver(),selectScreensaver.value||(selectScreensaver.value="none")}(context,userSettings),function(context,userSettings){var selectSoundEffects=context.querySelector(".selectSoundEffects"),options=pluginManager.ofType("soundeffects").map(function(plugin){return{name:plugin.name,value:plugin.id}});options.unshift({name:globalize.translate("None"),value:"none"}),selectSoundEffects.innerHTML=options.map(function(o){return'<option value="'+o.value+'">'+o.name+"</option>"}).join(""),selectSoundEffects.value=userSettings.soundEffects(),selectSoundEffects.value||(selectSoundEffects.value="none")}(context,userSettings),context.querySelector(".chkDisplayMissingEpisodes").checked=user.Configuration.DisplayMissingEpisodes||!1,context.querySelector(".chkThemeSong").checked=userSettings.enableThemeSongs(),context.querySelector(".chkThemeVideo").checked=userSettings.enableThemeVideos(),context.querySelector(".chkBackdrops").checked=userSettings.enableBackdrops(),context.querySelector(".chkSeasonalThemes").checked=userSettings.enableSeasonalThemes(),context.querySelector(".selectLanguage").value=userSettings.language()||"",context.querySelector(".selectDateTimeLocale").value=userSettings.dateTimeLocale()||"",selectSettingsTheme.value=userSettings.settingsTheme()||"",selectTheme.value=userSettings.theme()||"",context.querySelector(".selectLayout").value=layoutManager.getSavedLayout()||"",function(context,apiClient){"6da60dd6edfc4508bca2c434d4400816"!==apiClient.serverId()?context.querySelector(".fldDisplayMissingEpisodes").classList.remove("hide"):context.querySelector(".fldDisplayMissingEpisodes").classList.add("hide")}(context,apiClient),loading.hide()}function save(context,userId,userSettings,apiClient,enableSaveConfirmation){loading.show(),apiClient.getUser(userId).then(function(user){(function(context,user,userSettingsInstance,apiClient){return appSettings.runAtStartup(context.querySelector(".chkRunAtStartup").checked),user.Configuration.DisplayMissingEpisodes=context.querySelector(".chkDisplayMissingEpisodes").checked,appHost.supports("displaylanguage")&&userSettingsInstance.language(context.querySelector(".selectLanguage").value),userSettingsInstance.dateTimeLocale(context.querySelector(".selectDateTimeLocale").value),userSettingsInstance.enableThemeSongs(context.querySelector(".chkThemeSong").checked),userSettingsInstance.enableThemeVideos(context.querySelector(".chkThemeVideo").checked),userSettingsInstance.settingsTheme(context.querySelector(".selectSettingsTheme").value),userSettingsInstance.theme(context.querySelector(".selectTheme").value),userSettingsInstance.soundEffects(context.querySelector(".selectSoundEffects").value),userSettingsInstance.screensaver(context.querySelector(".selectScreensaver").value),userSettingsInstance.enableBackdrops(context.querySelector(".chkBackdrops").checked),userSettingsInstance.enableSeasonalThemes(context.querySelector(".chkSeasonalThemes").checked),layoutManager.setLayout(context.querySelector(".selectLayout").value),apiClient.updateUserConfiguration(user.Id,user.Configuration)})(context,user,userSettings,apiClient).then(function(){loading.hide(),enableSaveConfirmation&&require(["toast"],function(toast){toast(globalize.translate("SettingsSaved"))})},function(){loading.hide()})})}function onSubmit(e){var options=this,apiClient=connectionManager.getApiClient(options.serverId),userId=options.userId,userSettings=options.userSettings;return userSettings.setUserInfo(userId,apiClient).then(function(){var enableSaveConfirmation=options.enableSaveConfirmation;save(options.element,userId,userSettings,apiClient,enableSaveConfirmation)}),e&&e.preventDefault(),!1}function setPremiereText(elem,key){appHost.supports("externallinks")&&appHost.supports("externalpremium")?elem.innerHTML=globalize.translate(key,'<a is="emby-linkbutton" href="https://emby.media/premiere" data-preset="premiereinfo" target="_blank" class="button-link">',"</a>"):elem.innerHTML=globalize.translate(key,"","")}return function(view,params){var apiClient=connectionManager.getApiClient(params.serverId),userId=params.userId||apiClient.getCurrentUserId(),userSettings=userId===apiClient.getCurrentUserId()?currentUserSettings:new userSettingsBuilder,options={serverId:apiClient.serverId(),userId:userId,element:view.querySelector(".settingsContainer"),userSettings:userSettings,enableSaveButton:!1,enableSaveConfirmation:!1,autoFocus:!0};options.element.querySelector("form").addEventListener("submit",onSubmit.bind(options)),options.enableSaveButton&&options.element.querySelector(".btnSave").classList.remove("hide");for(var featurePremiereInfo=options.element.querySelectorAll(".featurePremiereInfo"),i=0,length=featurePremiereInfo.length;i<length;i++)setPremiereText(featurePremiereInfo[i],"FeatureRequiresEmbyPremiere");!function(view){var displayModePremiere=view.querySelector(".displayModePremiere");setPremiereText(displayModePremiere,"PlaybackTvModeRequiresEmbyPremiere"),iapManager.isUnlockedByDefault("playback").then(function(result){iapManager.isUnlockedByDefault("playback-tv").then(function(result){displayModePremiere.classList.add("hide")},function(result){displayModePremiere.classList.remove("hide")})},function(result){displayModePremiere.classList.add("hide")})}(view),view.addEventListener("viewshow",function(e){e.detail.isRestored||function(options){var context=options.element;loading.show();var userId=options.userId,apiClient=connectionManager.getApiClient(options.serverId),userSettings=options.userSettings;apiClient.getUser(userId).then(function(user){(userId===apiClient.getCurrentUserId()?Promise.resolve():userSettings.setUserInfo(userId,apiClient)).then(function(){loadForm(context,user,userSettings,apiClient),focusManager.autoFocus(context)})})}(options)}),view.addEventListener("viewbeforehide",function(){onSubmit.call(options)}),view.addEventListener("viewdestroy",function(){options=null})}});