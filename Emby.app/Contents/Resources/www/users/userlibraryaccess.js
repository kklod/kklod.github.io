define(["loading","appRouter","dom","globalize","emby-checkbox","emby-button","emby-linkbutton"],function(loading,appRouter,dom,globalize){"use strict";function triggerChange(select){var evt=document.createEvent("HTMLEvents");evt.initEvent("change",!1,!0),select.dispatchEvent(evt)}function renderMediaFolders(page,user,mediaFolders){var html="";html+='<h3 class="checkboxListLabel">'+globalize.translate("HeaderLibraries")+"</h3>",html+='<div class="checkboxList>';for(var i=0,length=mediaFolders.length;i<length;i++){var folder=mediaFolders[i],isChecked=user.Policy.EnableAllFolders||-1!==user.Policy.EnabledFolders.indexOf(folder.Id),checkedAttribute=isChecked?' checked="checked"':"";html+='<div class="checkboxList" style="margin:0 0 1.5em;">',html+='<label><input type="checkbox" is="emby-checkbox" class="chkFolder" data-id="'+folder.Id+'" '+checkedAttribute+'><span><h3 style="margin:0;">'+folder.Name+"</h3></span></label>",html+=function(user,folder,subFolders,folderEnabled){for(var html="",i=0,length=subFolders.length;i<length;i++){var subFolder=subFolders[i],idValue=folder.Id+"_"+subFolder.Id,checkedAttribute=user.Policy.EnableAllFolders||folderEnabled&&-1===(user.Policy.ExcludedSubFolders||[]).indexOf(idValue)?' checked="checked"':"";html+='<label style="margin: .5em 0 .5em 2.5em;"><input type="checkbox" is="emby-checkbox" class="chkSubFolder" data-folderid="'+folder.Id+'" data-id="'+idValue+'" '+checkedAttribute+"><span>"+subFolder.Path+"</span></label>"}return html}(user,folder,folder.SubFolders||[],isChecked),html+="</div>"}html+="</div>",page.querySelector(".folderAccess").innerHTML=html;var chkEnableAllFolders=page.querySelector(".chkEnableAllFolders");chkEnableAllFolders.checked=user.Policy.EnableAllFolders,triggerChange(chkEnableAllFolders)}function saveUser(user,page){user.Policy.EnableAllFolders=page.querySelector(".chkEnableAllFolders").checked,user.Policy.EnabledFolders=user.Policy.EnableAllFolders?[]:Array.prototype.filter.call(page.querySelectorAll(".chkFolder"),function(c){return c.checked}).map(function(c){return c.getAttribute("data-id")}),user.Policy.ExcludedSubFolders=user.Policy.EnableAllFolders?[]:Array.prototype.filter.call(page.querySelectorAll(".chkSubFolder"),function(c){return!c.checked}).map(function(c){return c.getAttribute("data-id")}),user.Policy.EnableAllChannels=page.querySelector(".chkEnableAllChannels").checked,user.Policy.EnabledChannels=user.Policy.EnableAllChannels?[]:Array.prototype.filter.call(page.querySelectorAll(".chkChannel"),function(c){return c.checked}).map(function(c){return c.getAttribute("data-id")}),user.Policy.EnableAllDevices=page.querySelector(".chkEnableAllDevices").checked,user.Policy.EnabledDevices=user.Policy.EnableAllDevices?[]:Array.prototype.filter.call(page.querySelectorAll(".chkDevice"),function(c){return c.checked}).map(function(c){return c.getAttribute("data-id")}),user.Policy.BlockedChannels=null,user.Policy.BlockedMediaFolders=null,ApiClient.updateUserPolicy(user.Id,user.Policy).then(function(){loading.hide(),require(["toast"],function(toast){toast(globalize.translate("SettingsSaved"))})})}function onFolderChange(e){var target=e.target,page=target.closest(".page");target.classList.contains("chkFolder")?function(page,folderId,checked){for(var elems=page.querySelectorAll('.chkSubFolder[data-folderid="'+folderId+'"]'),i=0,length=elems.length;i<length;i++)elems[i].checked=checked}(page,target.getAttribute("data-id"),target.checked):target.classList.contains("chkSubFolder")&&function(page,folderId){var elem=page.querySelector('.chkFolder[data-id="'+folderId+'"]');if(elem){var elems=page.querySelectorAll('.chkSubFolder[data-folderid="'+folderId+'"]');if(elems.length){for(var numChecked=0,numUnchecked=0,i=0,length=elems.length;i<length;i++)elems[i].checked?numChecked++:numUnchecked++;numChecked||numChecked===elems.length?elem.checked=!0:numUnchecked===elems.length&&(elem.checked=!1)}}}(page,target.getAttribute("data-folderid"))}return function(view,params){this.params=params,view.querySelector(".chkEnableAllDevices").addEventListener("change",function(){this.checked?view.querySelector(".deviceAccess").classList.add("hide"):view.querySelector(".deviceAccess").classList.remove("hide")}),view.querySelector(".chkEnableAllChannels").addEventListener("change",function(){this.checked?view.querySelector(".channelAccess").classList.add("hide"):view.querySelector(".channelAccess").classList.remove("hide")}),view.querySelector(".folderAccess").addEventListener("change",onFolderChange),view.querySelector(".chkEnableAllFolders").addEventListener("change",function(){this.checked?view.querySelector(".folderAccessListContainer").classList.add("hide"):view.querySelector(".folderAccessListContainer").classList.remove("hide")}),view.querySelector(".userLibraryAccessForm").addEventListener("submit",function(e){var page=e.target.closest(".page");loading.show();var userId=this.params.userId;return ApiClient.getUser(userId).then(function(result){saveUser(result,page)}),e.preventDefault(),e.stopPropagation(),!1}.bind(this));for(var userId=params.userId,btns=view.querySelectorAll(".userEditTabButton"),i=0,length=btns.length;i<length;i++)btns[i].href=btns[i].getAttribute("data-href")+"?userId="+userId+"&serverId="+ApiClient.serverId();view.addEventListener("viewshow",function(){var promise1,page=this;loading.show(),promise1=userId?ApiClient.getUser(userId):Promise.resolve({Configuration:{}});var promise5=ApiClient.getJSON(ApiClient.getUrl("Channels")),promise6=ApiClient.getJSON(ApiClient.getUrl("Devices"));Promise.all([promise1,promise5,promise6]).then(function(responses){var user=responses[0];page.querySelector(".username").innerHTML=user.Name,appRouter.setTitle(user.Name),function(page,user,channels){for(var html="",i=0,length=channels.length;i<length;i++){var folder=channels[i],checkedAttribute=user.Policy.EnableAllChannels||-1!==user.Policy.EnabledChannels.indexOf(folder.Id)?' checked="checked"':"";html+='<label><input type="checkbox" is="emby-checkbox" class="chkChannel" data-id="'+folder.Id+'" '+checkedAttribute+"><span>"+folder.Name+"</span></label>"}page.querySelector(".channelAccess").innerHTML=html,channels.length?page.querySelector(".channelAccessContainer").classList.remove("hide"):page.querySelector(".channelAccessContainer").classList.add("hide"),page.querySelector(".chkEnableAllChannels").checked=user.Policy.EnableAllChannels,triggerChange(page.querySelector(".chkEnableAllChannels"))}(page,user,responses[1].Items),function(page,user,devices){for(var html="",i=0,length=devices.length;i<length;i++){var device=devices[i],checkedAttribute=user.Policy.EnableAllDevices||-1!==(user.Policy.EnabledDevices||[]).indexOf(device.Id)?' checked="checked"':"";html+='<label><input type="checkbox" is="emby-checkbox" class="chkDevice" data-id="'+device.Id+'" '+checkedAttribute+"><span>"+device.Name+" - "+device.AppName+"</span></label>"}page.querySelector(".deviceAccess").innerHTML=html,page.querySelector(".chkEnableAllDevices").checked=user.Policy.EnableAllDevices,triggerChange(page.querySelector(".chkEnableAllDevices")),user.Policy.IsAdministrator?page.querySelector(".deviceAccessContainer").classList.add("hide"):page.querySelector(".deviceAccessContainer").classList.remove("hide")}(page,user,responses[2].Items),function(page,user){ApiClient.getJSON(ApiClient.getUrl("Library/SelectableMediaFolders")).then(function(mediaFolders){renderMediaFolders(page,user,mediaFolders)})}(page,user),loading.hide()})})}});