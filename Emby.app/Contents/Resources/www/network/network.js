define(["loading","globalize","formHelper","emby-checkbox","emby-select","emby-input","emby-button"],function(loading,globalize,formHelper){"use strict";function onSubmit(e){var form=this,localAddress=form.querySelector("#txtLocalAddress").value,enableUpnp=form.querySelector("#chkEnableUpnp").checked;!function(localAddress,enableUpnp,callback){localAddress||!enableUpnp?alertText({text:globalize.translate("SettingsWarning")}).then(callback):callback()}(localAddress,enableUpnp,function(){var validationResult=function(form){return form.querySelector("#txtPublicPort").value!==form.querySelector("#txtPublicHttpsPort").value?form.querySelector("#txtPortNumber").value!==form.querySelector("#txtHttpsPort").value?null:"The http and https ports must be different.":"The public http and https ports must be different."}(form);validationResult?alertText(validationResult):function(form){var certPath=form.querySelector("#txtCertificatePath").value||null,httpsMode=form.querySelector("#selectHttpsMode").value;return"enabled"!==httpsMode&&"required"!==httpsMode||certPath?Promise.resolve():new Promise(function(resolve,reject){return alertText({text:globalize.translate("HttpsRequiresCert")}).then(reject,reject)})}(form).then(function(){loading.show(),ApiClient.getServerConfiguration().then(function(config){config.LocalNetworkSubnets=form.querySelector("#txtLanNetworks").value.split(",").map(function(s){return s.trim()}).filter(function(s){return 0<s.length}),config.RemoteIPFilter=form.querySelector("#txtExternalAddressFilter").value.split(",").map(function(s){return s.trim()}).filter(function(s){return 0<s.length}),config.IsRemoteIPFilterBlacklist="blacklist"===form.querySelector("#selectExternalAddressFilterMode").value,config.PublicPort=form.querySelector("#txtPublicPort").value,config.PublicHttpsPort=form.querySelector("#txtPublicHttpsPort").value;var httpsMode=form.querySelector("#selectHttpsMode").value;"proxy"===httpsMode?(config.EnableHttps=!0,config.RequireHttps=!1,config.IsBehindProxy=!0):("required"===httpsMode?(config.EnableHttps=!0,config.RequireHttps=!0):(config.EnableHttps="enabled"===httpsMode,config.RequireHttps=!1),config.IsBehindProxy=!1),config.HttpsPortNumber=form.querySelector("#txtHttpsPort").value,config.HttpServerPortNumber=form.querySelector("#txtPortNumber").value,config.EnableUPnP=enableUpnp,config.SimultaneousStreamLimit=form.querySelector("#selectStreamLimit").value,config.WanDdns=form.querySelector("#txtDdns").value,config.EnableRemoteAccess=form.querySelector("#chkRemoteAccess").checked,config.CertificatePath=form.querySelector("#txtCertificatePath").value||null,config.CertificatePassword=form.querySelector("#txtCertPassword").value||null,config.RemoteClientBitrateLimit=parseInt(1e6*parseFloat(form.querySelector("#txtRemoteClientBitrateLimit").value||"0")),config.LocalNetworkAddresses=localAddress?[localAddress]:[],ApiClient.updateServerConfiguration(config).then(formHelper.handleConfigurationSavedResponse,formHelper.handleErrorResponse)})})}),e.preventDefault()}function alertText(options){return new Promise(function(resolve,reject){require(["alert"],function(alert){alert(options).then(resolve,reject)})})}function isPortMapperPlugin(p){return p.Id.toLowerCase()==="96FA50A4-69CE-42AC-B6A3-EF6B3388CCB7".toLowerCase()}return function(view,params){var portMapperDetermined=!1,portMapperSupported=!0;function loadPage(page,config){page.querySelector("#txtPortNumber").value=config.HttpServerPortNumber,page.querySelector("#txtPublicPort").value=config.PublicPort,page.querySelector("#txtPublicHttpsPort").value=config.PublicHttpsPort,page.querySelector("#txtLocalAddress").value=config.LocalNetworkAddresses[0]||"",page.querySelector("#txtLanNetworks").value=(config.LocalNetworkSubnets||[]).join(", "),page.querySelector("#txtExternalAddressFilter").value=(config.RemoteIPFilter||[]).join(", "),page.querySelector("#txtRemoteClientBitrateLimit").value=config.RemoteClientBitrateLimit/1e6||"",page.querySelector("#selectExternalAddressFilterMode").value=config.IsRemoteIPFilterBlacklist?"blacklist":"whitelist",page.querySelector("#chkRemoteAccess").checked=null==config.EnableRemoteAccess||config.EnableRemoteAccess;var selectHttpsMode=page.querySelector("#selectHttpsMode");config.IsBehindProxy?selectHttpsMode.value="proxy":config.RequireHttps?selectHttpsMode.value="required":config.EnableHttps?selectHttpsMode.value="enabled":selectHttpsMode.value="disabled",page.querySelector("#txtHttpsPort").value=config.HttpsPortNumber,page.querySelector("#txtDdns").value=config.WanDdns||"";var select,evt,txtCertificatePath=page.querySelector("#txtCertificatePath");txtCertificatePath.value=config.CertificatePath||"",page.querySelector("#txtCertPassword").value=config.CertificatePassword||"",page.querySelector("#chkEnableUpnp").checked=config.EnableUPnP,page.querySelector("#selectStreamLimit").value=config.SimultaneousStreamLimit||"0",onCertPathChange.call(txtCertificatePath),select=page.querySelector("#chkRemoteAccess"),(evt=document.createEvent("HTMLEvents")).initEvent("change",!1,!0),select.dispatchEvent(evt),loading.hide()}function onCertPathChange(){}view.querySelector(".fldStreamLimit").classList.remove("hide"),function(view){for(var html='<option value="0">'+globalize.translate("Unlimited")+"</option>",i=1;i<=50;i++)html+='<option value="'+i+'">'+i+"</option>";view.querySelector("#selectStreamLimit").innerHTML=html}(view),view.querySelector(".streamLimitPremiereInfo").innerHTML=globalize.translate("FeatureRequiresEmbyPremiere",'<a href="https://emby.media/premiere" data-preset="premiereinfo" is="emby-linkbutton" type="button" class="button-link">',"</a>"),view.querySelector("#chkRemoteAccess").addEventListener("change",function(){this.checked?(view.querySelector(".fldExternalAddressFilter").classList.remove("hide"),view.querySelector(".fldExternalAddressFilterMode").classList.remove("hide"),view.querySelector(".fldPublicPort").classList.remove("hide"),view.querySelector(".fldPublicHttpsPort").classList.remove("hide"),view.querySelector(".fldDdns").classList.remove("hide"),view.querySelector(".fldCertificatePath").classList.remove("hide"),view.querySelector(".fldCertPassword").classList.remove("hide"),view.querySelector(".fldHttpsMode").classList.remove("hide"),view.querySelector(".fldRemoteBitrate").classList.remove("hide"),portMapperSupported?view.querySelector(".fldEnableUpnp").classList.remove("hide"):view.querySelector(".fldEnableUpnp").classList.add("hide")):(view.querySelector(".fldExternalAddressFilter").classList.add("hide"),view.querySelector(".fldExternalAddressFilterMode").classList.add("hide"),view.querySelector(".fldPublicPort").classList.add("hide"),view.querySelector(".fldPublicHttpsPort").classList.add("hide"),view.querySelector(".fldDdns").classList.add("hide"),view.querySelector(".fldCertificatePath").classList.add("hide"),view.querySelector(".fldCertPassword").classList.add("hide"),view.querySelector(".fldHttpsMode").classList.add("hide"),view.querySelector(".fldEnableUpnp").classList.add("hide"),view.querySelector(".fldRemoteBitrate").classList.add("hide"))}),view.querySelector("#btnSelectCertPath").addEventListener("click",function(){require(["directorybrowser"],function(directoryBrowser){var picker=new directoryBrowser;picker.show({includeFiles:!0,includeDirectories:!0,callback:function(path){path&&(view.querySelector("#txtCertificatePath").value=path),picker.close()},header:globalize.translate("HeaderSelectCertificatePath")})})}),view.querySelector(".dashboardHostingForm").addEventListener("submit",onSubmit),view.querySelector("#txtCertificatePath").addEventListener("change",onCertPathChange),view.addEventListener("viewshow",function(e){loading.show(),(portMapperDetermined?Promise.resolve():ApiClient.getInstalledPlugins().then(function(plugins){portMapperDetermined=!0,plugins.filter(isPortMapperPlugin).length||(portMapperSupported=!1)})).then(function(){ApiClient.getServerConfiguration().then(function(config){loadPage(view,config)})})}),function(view){ApiClient.getSystemInfo().then(function(systemInfo){!1!==systemInfo.SupportsLocalPortConfiguration?(view.querySelector(".fldlocalHttpPort").classList.remove("hide"),view.querySelector(".fldlocalHttpsPort").classList.remove("hide")):(view.querySelector(".fldlocalHttpPort").classList.add("hide"),view.querySelector(".fldlocalHttpsPort").classList.add("hide"))})}(view)}});