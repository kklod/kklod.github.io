define(["textEncoding","loading","events","globalize","serverNotifications","humanedate","listViewStyle","emby-linkbutton"],function(textEncoding,loading,events,globalize,serverNotifications,humanedate){"use strict";function reloadList(page){ApiClient.getScheduledTasks({isHidden:!1}).then(function(tasks){!function(page,tasks){tasks=tasks.sort(function(a,b){return(a=a.Category+" "+a.Name)===(b=b.Category+" "+b.Name)?0:a<b?-1:1});for(var currentCategory,html="",i=0,length=tasks.length;i<length;i++){var task=tasks[i];task.Category!==currentCategory&&((currentCategory=task.Category)&&(html+="</div>",html+="</div>"),html+='<div class="verticalSection verticalSection-extrabottompadding">',html+='<div class="sectionTitleContainer">',html+='<h2 class="sectionTitle">',html+=currentCategory,html+="</h2>",html+="</div>",html+="<div>"),html+='<div class="listItem listItem-border scheduledTaskPaperIconItem" data-status="'+task.State+'">',html+='<div class="listItemBody two-line listItemBody-noleftpadding">',html+="<a class='clearLink' style='margin:0;padding:0;display:block;text-align:left;font-weight:inherit;' is='emby-linkbutton' href='scheduledtask?id="+task.Id+"'>",html+="<div class='listItemBodyText listItemBodyText-lf' style='font-weight:500;'>"+task.Name+"</div>",html+="<div class='listItemBodyText-secondary listItemBodyText taskProgress"+task.Id+"'>"+getTaskProgressHtml(task)+"</div>",html+="<div class='listItemBodyText-secondary listItemBodyText'>"+textEncoding.htmlEncode(task.Description||"")+"</div>",html+="</a>",html+="</div>","Idle"===task.State?html+='<button type="button" is="paper-icon-button-light" class="listItemButton btnTask'+task.Id+' btnStartTask" data-taskid="'+task.Id+'" title="'+globalize.translate("ButtonStart")+'" aria-label="'+globalize.translate("ButtonStart")+'"><i class="md-icon">play_circle_filled</i></button>':"Running"===task.State?html+='<button type="button" is="paper-icon-button-light" class="listItemButton btnTask'+task.Id+' btnStopTask" data-taskid="'+task.Id+'" title="'+globalize.translate("ButtonStop")+'" aria-label="'+globalize.translate("ButtonStop")+'"><i class="md-icon">stop</i></button>':html+='<button type="button" is="paper-icon-button-light" class="listItemButton btnTask'+task.Id+' btnStartTask hide" data-taskid="'+task.Id+'" title="'+globalize.translate("ButtonStart")+'" aria-label="'+globalize.translate("ButtonStart")+'"><i class="md-icon">play_circle_filled</i></button>',html+="</div>"}tasks.length&&(html+="</div>",html+="</div>");page.querySelector(".divScheduledTasks").innerHTML=html}(page,tasks),loading.hide()})}function getTaskProgressHtml(task){var progress,firstDateStr,secondDateStr,dt1,seconds,numdays,numhours,numminutes,numseconds,elapsedStr,html="";return"Idle"===task.State?task.LastExecutionResult&&(html+=globalize.translate("LabelScheduledTaskLastRan").replace("{0}",humanedate(task.LastExecutionResult.EndTimeUtc)).replace("{1}",(firstDateStr=task.LastExecutionResult.StartTimeUtc,secondDateStr=task.LastExecutionResult.EndTimeUtc,dt1=new Date(firstDateStr),seconds=(new Date(secondDateStr).getTime()-dt1.getTime())/1e3,numdays=Math.floor(seconds%31536e3/86400),numhours=Math.floor(seconds%31536e3%86400/3600),numminutes=Math.floor(seconds%31536e3%86400%3600/60),numseconds=Math.round(seconds%31536e3%86400%3600%60),elapsedStr="",elapsedStr+=1===numdays?numdays+" day ":"",elapsedStr+=1<numdays?numdays+" days ":"",elapsedStr+=1===numhours?numhours+" hour ":"",elapsedStr+=1<numhours?numhours+" hours ":"",elapsedStr+=1===numminutes?numminutes+" minute ":"",elapsedStr+=1<numminutes?numminutes+" minutes ":"",elapsedStr+=0<elapsedStr.length?"and ":"",elapsedStr+=1===numseconds?numseconds+" second":"",elapsedStr+=0===numseconds||1<numseconds?numseconds+" seconds":"")),"Failed"===task.LastExecutionResult.Status?html+=" <span style='color:#FF0000;'>("+globalize.translate("LabelFailed")+")</span>":"Cancelled"===task.LastExecutionResult.Status?html+=" <span style='color:#0026FF;'>("+globalize.translate("LabelCancelled")+")</span>":"Aborted"===task.LastExecutionResult.Status&&(html+=" <span style='color:#FF0000;'>"+globalize.translate("LabelAbortedByServerShutdown")+"</span>")):"Running"===task.State?(html+='<div style="display:flex;align-items:center;">',html+='<div class="taskProgressOuter" title="'+(progress=(task.CurrentProgressPercentage||0).toFixed(1))+'%" style="flex-grow:1;">',html+='<div class="taskProgressInner" style="width:'+progress+'%;">',html+="</div>",html+="</div>",html+="<span style='margin-left:.25em;'>"+progress+"%</span>",html+="</div>"):html+="<span style='color:#FF0000;'>"+globalize.translate("LabelStopping")+"</span>",html}function updateTaskButton(elem,state){var title="Idle"===state?(elem.classList.add("btnStartTask"),elem.classList.remove("btnStopTask"),elem.classList.remove("hide"),elem.querySelector("i").innerHTML="play_circle_filled",globalize.translate("ButtonStart")):"Running"===state?(elem.classList.remove("btnStartTask"),elem.classList.add("btnStopTask"),elem.classList.remove("hide"),elem.querySelector("i").innerHTML="stop",globalize.translate("ButtonStop")):(elem.classList.add("btnStartTask"),elem.classList.remove("btnStopTask"),elem.classList.add("hide"),elem.querySelector("i").innerHTML="play_circle_filled",globalize.translate("ButtonStart"));elem.title=title,elem.setAttribute("aria-label",title),elem.closest(".listItem").setAttribute("data-status",state)}return function(view,params){var pollInterval,serverId=ApiClient.serverId();function onPollIntervalFired(){ApiClient.isMessageChannelOpen()||reloadList(view)}function onScheduledTasksUpdate(e,apiClient,info){apiClient.serverId()===serverId&&function(tasks){for(var i=0,length=tasks.length;i<length;i++){var task=tasks[i];view.querySelector(".taskProgress"+task.Id).innerHTML=getTaskProgressHtml(task),updateTaskButton(view.querySelector(".btnTask"+task.Id),task.State)}}(info)}view.querySelector(".divScheduledTasks").addEventListener("click",function(e){var id,button=e.target.closest(".btnStartTask");button&&(id=button.getAttribute("data-taskid"),ApiClient.startScheduledTask(id).then(function(){updateTaskButton(button,"Running"),reloadList(view)}))}),view.querySelector(".divScheduledTasks").addEventListener("click",function(e){var id,button=e.target.closest(".btnStopTask");button&&(id=button.getAttribute("data-taskid"),ApiClient.stopScheduledTask(id).then(function(){updateTaskButton(button,""),reloadList(view)}))}),view.addEventListener("viewbeforehide",function(){events.off(serverNotifications,"ScheduledTasksInfo",onScheduledTasksUpdate),ApiClient.stopMessageListener("ScheduledTasksInfo"),pollInterval&&clearInterval(pollInterval)}),view.addEventListener("viewshow",function(){loading.show(),ApiClient.startMessageListener("ScheduledTasksInfo","1000,1000"),pollInterval&&clearInterval(pollInterval),pollInterval=setInterval(onPollIntervalFired,1e4),reloadList(view),events.on(serverNotifications,"ScheduledTasksInfo",onScheduledTasksUpdate)})}});