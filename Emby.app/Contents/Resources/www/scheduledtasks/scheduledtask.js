define(["loading","datetime","dom","globalize","emby-input","emby-button","emby-select","listViewStyle"],function(loading,datetime,dom,globalize){"use strict";function loadTaskTriggers(context,task){var html="";html+="<div>";for(var i=0,length=task.Triggers.length;i<length;i++){var hours,trigger=task.Triggers[i];html+='<div class="listItem listItem-border">',html+='<i class="md-icon listItemIcon">schedule</i>',trigger.MaxRuntimeTicks?html+='<div class="listItemBody two-line">':html+='<div class="listItemBody">',html+="<div class='listItemBodyText'>"+function(trigger){if("DailyTrigger"===trigger.Type)return"Daily at "+getDisplayTime(trigger.TimeOfDayTicks);if("WeeklyTrigger"===trigger.Type)return trigger.DayOfWeek+"s at "+getDisplayTime(trigger.TimeOfDayTicks);if("SystemEventTrigger"===trigger.Type&&"WakeFromSleep"===trigger.SystemEvent)return"On wake from sleep";if("IntervalTrigger"!==trigger.Type)return"StartupTrigger"!==trigger.Type?trigger.Type:"On application startup";var hours=trigger.IntervalTicks/36e9;return.25!=hours?.5!=hours?.75!=hours?1!=hours?"Every "+hours+" hours":"Every hour":"Every 45 minutes":"Every 30 minutes":"Every 15 minutes"}(trigger)+"</div>",trigger.MaxRuntimeTicks&&(html+='<div class="listItemBodyText listItemBodyText-secondary">',html+=1==(hours=trigger.MaxRuntimeTicks/36e9)?globalize.translate("ValueTimeLimitSingleHour"):globalize.translate("ValueTimeLimitMultiHour",hours),html+="</div>"),html+="</div>",html+='<button class="btnDeleteTrigger" data-index="'+i+'" type="button" is="paper-icon-button-light" title="'+globalize.translate("ButtonDelete")+'" aria-label="'+globalize.translate("ButtonDelete")+'"><i class="md-icon">delete</i></button>',html+="</div>"}html+="</div>",context.querySelector(".taskTriggers").innerHTML=html}function refreshScheduledTask(view,id){loading.show(),ApiClient.getScheduledTask(id).then(function(task){!function(view,task){view.querySelector(".taskName").innerHTML=task.Name,view.querySelector(".pTaskDescription").innerHTML=task.Description,loadTaskTriggers(view,task),loading.hide()}(view,task)})}function confirmDeleteTrigger(view,id,index){require(["confirm"],function(confirm){confirm(globalize.translate("MessageDeleteTaskTrigger"),globalize.translate("HeaderDeleteTaskTrigger")).then(function(){!function(view,id,index){loading.show(),ApiClient.getScheduledTask(id).then(function(task){task.Triggers.remove(index),ApiClient.updateScheduledTaskTriggers(task.Id,task.Triggers).then(function(){refreshScheduledTask(view,id)})})}(view,id,index)})})}function getDisplayTime(ticks){var ms=ticks/1e4,now=new Date;return now.setHours(0,0,0,0),now.setTime(now.getTime()+ms),datetime.getDisplayTime(now)}return Array.prototype.remove=function(from,to){var rest=this.slice((to||from)+1||this.length);return this.length=from<0?this.length+from:from,this.push.apply(this,rest)},function(view,params){view.querySelector(".addTriggerForm").addEventListener("submit",function(e){loading.show();var id=params.id;ApiClient.getScheduledTask(id).then(function(task){task.Triggers.push(function(page){var trigger={Type:page.querySelector(".selectTriggerType").value};"DailyTrigger"===trigger.Type?trigger.TimeOfDayTicks=page.querySelector(".selectTimeOfDay").value:"WeeklyTrigger"===trigger.Type?(trigger.DayOfWeek=page.querySelector(".selectDayOfWeek").value,trigger.TimeOfDayTicks=page.querySelector(".selectTimeOfDay").value):"SystemEventTrigger"===trigger.Type?trigger.SystemEvent=page.querySelector(".selectSystemEvent").value:"IntervalTrigger"===trigger.Type&&(trigger.IntervalTicks=page.querySelector(".selectInterval").value);var timeLimit=page.querySelector(".txtTimeLimit").value||"0",timeLimit=36e9*parseFloat(timeLimit);return trigger.MaxRuntimeTicks=timeLimit||null,trigger}(view)),ApiClient.updateScheduledTaskTriggers(task.Id,task.Triggers).then(function(){view.querySelector(".popupAddTrigger").classList.add("hide"),refreshScheduledTask(view,id)})}),e.preventDefault()}),view.querySelector(".btnCancelPopup").addEventListener("click",function(){this.closest(".dialog").classList.add("hide")}),function(select){for(var options=[],i=0;i<864e5;i+=9e5)options.push({name:getDisplayTime(1e4*i),value:1e4*i});select.innerHTML=options.map(function(o){return'<option value="'+o.value+'">'+o.name+"</option>"}).join("")}(view.querySelector(".selectTimeOfDay")),view.querySelector(".selectTriggerType").addEventListener("change",function(){var page,triggerType;page=view,"DailyTrigger"===(triggerType=this.value)?(page.querySelector(".fldTimeOfDay").classList.remove("hide"),page.querySelector(".fldDayOfWeek").classList.add("hide"),page.querySelector(".fldSelectSystemEvent").classList.add("hide"),page.querySelector(".fldSelectInterval").classList.add("hide"),page.querySelector(".selectTimeOfDay").setAttribute("required","required")):"WeeklyTrigger"===triggerType?(page.querySelector(".fldTimeOfDay").classList.remove("hide"),page.querySelector(".fldDayOfWeek").classList.remove("hide"),page.querySelector(".fldSelectSystemEvent").classList.add("hide"),page.querySelector(".fldSelectInterval").classList.add("hide"),page.querySelector(".selectTimeOfDay").setAttribute("required","required")):"SystemEventTrigger"===triggerType?(page.querySelector(".fldTimeOfDay").classList.add("hide"),page.querySelector(".fldDayOfWeek").classList.add("hide"),page.querySelector(".fldSelectSystemEvent").classList.remove("hide"),page.querySelector(".fldSelectInterval").classList.add("hide"),page.querySelector(".selectTimeOfDay").removeAttribute("required")):"IntervalTrigger"===triggerType?(page.querySelector(".fldTimeOfDay").classList.add("hide"),page.querySelector(".fldDayOfWeek").classList.add("hide"),page.querySelector(".fldSelectSystemEvent").classList.add("hide"),page.querySelector(".fldSelectInterval").classList.remove("hide"),page.querySelector(".selectTimeOfDay").removeAttribute("required")):"StartupTrigger"===triggerType&&(page.querySelector(".fldTimeOfDay").classList.add("hide"),page.querySelector(".fldDayOfWeek").classList.add("hide"),page.querySelector(".fldSelectSystemEvent").classList.add("hide"),page.querySelector(".fldSelectInterval").classList.add("hide"),page.querySelector(".selectTimeOfDay").removeAttribute("required"))}),view.querySelector(".btnAddTrigger").addEventListener("click",function(){!function(view){view.querySelector(".selectTriggerType").value="DailyTrigger",view.querySelector(".selectTriggerType").dispatchEvent(new CustomEvent("change",{})),view.querySelector(".popupAddTrigger").classList.remove("hide")}(view)}),view.addEventListener("click",function(e){var btnDeleteTrigger=e.target.closest(".btnDeleteTrigger");btnDeleteTrigger&&confirmDeleteTrigger(view,params.id,parseInt(btnDeleteTrigger.getAttribute("data-index")))}),function(context){for(var elems=context.querySelectorAll(".selectDayOfWeek option"),date=new Date;0<date.getDay();)date.setDate(date.getDate()-1);for(var i=0,length=elems.length;i<length;i++)elems[i].innerHTML=datetime.toLocaleDateString(date,{weekday:"long"}),date.setDate(date.getDate()+1)}(view),view.addEventListener("viewshow",function(){refreshScheduledTask(view,params.id)})}});