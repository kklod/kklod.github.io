define(["dom","layoutManager","apphost","events","css!./headroom"],function(dom,layoutManager,appHost,events){"use strict";function Headroom(options){options=options||{},this.lastScrollY=0,this.lastTransformScrollY=0,this.element=options.element,this.scrollElementForEvents=options.scroller||window,this.scroller=this.scrollElementForEvents,this.updateFn=this.update.bind(this),this.offset=options.offset,this.initialised=!1}var supportsCssEnv=function(){if("android"===self.appMode)return!0;try{var val=getComputedStyle(document.documentElement).getPropertyValue("--env-inset-top");if(val&&!val.includes("env("))return!0}catch(err){}return!1}();!function(){try{document.documentElement.style.setProperty("--env-inset-top","1")}catch(err){}}();var topCalc="android"===self.appMode?"translateY(calc(-100% + var(--window-inset-top, 0)))":"translateY(calc(-100% + env(safe-area-inset-top, 0)))",supportsCssTransforms=CSS.supports("transform","scale(1)");function setTransformImmediate(elem,classList,value){classList.add("headroom-notransition"),elem.style.transform=value,elem.offsetWidth,classList.remove("headroom-notransition")}return Headroom.prototype={constructor:Headroom,init:function(){return this.active=!1,supportsCssTransforms&&this.attachEvent(),this},pause:function(){this.paused=!0},beginResume:function(){this.paused&&this.allowBeginResume&&(this.paused=!1,this.update(null,!0,!0,!0))},resume:function(){this.paused&&(this.paused=!1,this.update(null,!0,!0,!1))},destroy:function(){this.initialised=!1,this.lastScrollY=null,this.lastTransformScrollY=null;var scroller=this.scrollElementForEvents;scroller&&(scroller.removeScrollEventListener?scroller.removeScrollEventListener(this.updateFn,{capture:!1,passive:!0}):dom.removeEventListener(scroller,"scroll",this.updateFn,{capture:!1,passive:!0})),this.scrollElementForEvents=null,this.scroller=null,this.element=null},attachEvent:function(){var scroller;this.initialised||(this.lastScrollY=this.scroller.getScrollPosition(),this.allowBeginResume=!this.scroller.isNativeScroll(),this.lastTransformScrollY=this.lastScrollY,this.initialised=!0,(scroller=this.scrollElementForEvents)&&(scroller.addScrollEventListener?scroller.addScrollEventListener(this.updateFn,{capture:!1,passive:!0}):dom.addEventListener(scroller,"scroll",this.updateFn,{capture:!1,passive:!0})),this.update(null,!0,!0))},setTransform:function(value,top,forceRefresh,immediate){var elem,isActive,classList;value===this.transform&&!forceRefresh||(elem=this.element)&&value!==elem.headroomTransform&&(this.transform=value,0===(elem.headroomTransform=value)?value="none":isActive=(value=1===value?supportsCssEnv?topCalc:"translateY(-100%)":"translateY(-"+value+"px)",!0),classList=elem.classList,this.active===isActive&&!forceRefresh||((this.active=isActive)?classList.add("headroom-active"):classList.remove("headroom-active")),immediate?layoutManager.tv?this.setTransformWithAnimationFrame(elem,classList,value):setTransformImmediate(elem,classList,value):elem.style.transform=value)},setTransformWithAnimationFrame:function(elem,classList,value){requestAnimationFrame(function(){setTransformImmediate(elem,classList,value)})},update:function(e,forceRefresh,immediate,enableBackgroundSupport){var currentScrollY,lastScrollY,isTv,scrollingDirection,lastTransformScrollY,scrollThreshold,top,toleranceExceeded,previousTransform,newValue;this.paused||(!enableBackgroundSupport||this.allowBeginResume?currentScrollY=this.scroller.getScrollPosition():null==(currentScrollY=this.scroller.getLastScrollPosition())&&(currentScrollY=this.lastScrollY||0),currentScrollY<0||(lastScrollY=this.lastScrollY,isTv=layoutManager.tv,scrollingDirection=lastScrollY<currentScrollY?1:currentScrollY<lastScrollY?-1:0,(forceRefresh=!0===forceRefresh)&&(scrollingDirection=0),scrollThreshold=10,-1===scrollingDirection?(lastTransformScrollY=this.lastTransformScrollY,scrollThreshold=40):lastTransformScrollY=lastScrollY,top=currentScrollY<=(isTv?130:0),toleranceExceeded=forceRefresh||Math.abs(currentScrollY-lastTransformScrollY)>scrollThreshold,1===scrollingDirection&&!top&&toleranceExceeded?(this.lastTransformScrollY=currentScrollY,this.setTransform(1,top,forceRefresh,immediate)):-1===scrollingDirection&&!isTv&&toleranceExceeded||top?(this.lastTransformScrollY=currentScrollY,this.setTransform(0,top,forceRefresh||top,immediate)):!scrollingDirection&&forceRefresh&&(this.lastTransformScrollY=currentScrollY,previousTransform=this.transform,newValue=top?0:null==previousTransform?1:previousTransform,this.setTransform(newValue,top,forceRefresh||top,immediate))),this.lastScrollY=currentScrollY)}},Headroom});