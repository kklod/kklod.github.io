define(["backdrop","globalize","layoutManager","appHeader","mainTabsManager","inputManager","connectionManager","baseView","userSettings","emby-tabs"],function(backdrop,globalize,layoutManager,appHeader,mainTabsManager,inputManager,connectionManager,BaseView,userSettings){"use strict";(cores=navigator.hardwareConcurrency||4)<4||2400<=(screen.width||screen.availWidth||0)||screen.height||screen.availHeight;var cores,fadeSize="1.5%",fadeDuration=300;function loadTab(instance,index,previousIndex,previousTabController){instance.getTabController(index).then(function(controller){var elem,keyframes,timing,refresh=!controller.refreshed,autoFocus=null==previousIndex&&layoutManager.tv;autoFocus||previousTabController&&previousTabController.view&&!appHeader.hasFocus()&&(autoFocus=!0),controller.onResume({autoFocus:autoFocus,refresh:refresh}),null!=previousIndex&&layoutManager.tv&&controller.view&&controller.view.animate&&(index<previousIndex?(elem=controller.view,keyframes=[{opacity:"0",transform:"translate3d(-"+fadeSize+", 0, 0)",offset:0},{opacity:"1",transform:"none",offset:1}],timing={duration:fadeDuration,iterations:1},elem.animate(keyframes,timing)):previousIndex<index&&function(elem){var keyframes=[{opacity:"0",transform:"translate3d("+fadeSize+", 0, 0)",offset:0},{opacity:"1",transform:"none",offset:1}],timing={duration:fadeDuration,iterations:1};elem.animate(keyframes,timing)}(controller.view)),controller.refreshed=!0,instance.currentTabIndex=index,instance.currentTabController=controller})}function TabbedView(view,params){BaseView.apply(this,arguments),this.onInputCommandFn=function(e){var currentTabController;"refresh"!==e.detail.command||(currentTabController=this.currentTabController)&&currentTabController.refresh&&currentTabController.refresh({refresh:!0})}.bind(this),this.getTabContainersFn=function(){return this.view.querySelectorAll(".tabContent")}.bind(this),this.onTabChangeFn=function(e){var newIndex=parseInt(e.detail.selectedTabIndex),previousIndex=e.detail.previousIndex,previousTabController=null==previousIndex?null:this.tabControllers[previousIndex];previousTabController&&previousTabController.onPause&&previousTabController.onPause(),loadTab(this,newIndex,previousIndex,previousTabController)}.bind(this),this.getLoadedTabsFn=this.getLoadedTabs.bind(this);var onInputCommandFn=this.onInputCommandFn;onInputCommandFn&&inputManager.on(view,onInputCommandFn),this.tabControllers=[]}function onItemRefreshed(item){return this.item=item,this.setTitle(),this.setTabs(),Promise.resolve()}return Object.assign(TabbedView.prototype,BaseView.prototype),TabbedView.prototype.getItem=function(){var params=this.params;if(!params.parentId)return Promise.resolve(null);var apiClient=connectionManager.getApiClient(params.serverId);return apiClient.getItem(apiClient.getCurrentUserId(),params.parentId)},TabbedView.prototype.getLoadedTabs=function(){var tabs=this._tabs;if(!tabs){if(tabs=this.getTabs(),layoutManager.tv){for(var tab,enabledTabs=[],i=0,length=tabs.length;i<length;i++)!1!==(tab=tabs[i]).enabled&&enabledTabs.push(tab);if(20<enabledTabs.length)for(i=20,length=enabledTabs.length;i<length;i++)(tab=enabledTabs[i]).enabled=!1}this._tabs=tabs}return tabs},TabbedView.prototype.getDefaultTabUserSettingsValue=function(folderId){return userSettings.get("landing-"+folderId)},TabbedView.prototype.getDefaultTabIndex=function(folderId){var defaultTab=this.getDefaultTabUserSettingsValue(folderId)||this.getDefaultTabId(),tabs=this.getLoadedTabs(),index=this.getTabIndex(defaultTab,tabs);if(null!=index)return index;for(var i=0,length=tabs.length;i<length;i++){if(!1!==tabs[i].enabled)return i}},TabbedView.prototype.getDefaultTabId=function(){return null},TabbedView.prototype.getTabControllerOptions=function(id){var options={};return"albumartists"===id?options.mode="albumartists":"composers"===id?options.mode="composers":"genres"===id&&(options.queryIncludeItemTypes=[]),options},TabbedView.prototype.getTabController=function(index){var controller=this.tabControllers[index];if(controller)return Promise.resolve(controller);var tabInfo=this.getLoadedTabs()[index],instance=this;return this.loadTabController(tabInfo.id).then(function(responses){var controllerFactory=responses[0];if(controller=instance.tabControllers[index])return controller;var controller=new controllerFactory(instance.view.querySelector(".tabContent[data-index='"+index+"']"),instance.params,instance.getTabControllerOptions(tabInfo.id));return function(controller){return controller.loadTemplate().then(function(responses){return responses&&responses.length&&(controller.view.innerHTML=globalize.translateDocument(responses[0])),controller.onTemplateLoaded(),controller})}(instance.tabControllers[index]=controller)})},TabbedView.prototype.getTabIndex=function(id,tabs){for(var tab,i=0,length=(tabs=tabs||this.getLoadedTabs()).length;i<length;i++)if(!1!==(tab=tabs[i]).enabled&&tab.id===id)return i;return null},TabbedView.prototype.setTabs=function(options){var params;null==this.currentTabIndex&&((params=this.params).tab&&(this.currentTabIndex=this.getTabIndex(params.tab)),null==this.currentTabIndex&&(this.currentTabIndex=this.getDefaultTabIndex(params.parentId)),this.initialTabIndex=this.currentTabIndex);var currentTabController=this.currentTabController;mainTabsManager.setTabs(this.view,this.currentTabIndex,this.getLoadedTabsFn,this.getTabContainersFn,this.onTabChangeFn,null==currentTabController)},TabbedView.prototype.onBeginResume=function(options){var instance;BaseView.prototype.onBeginResume.apply(this,arguments),this.params.serverId?this.refreshItemPromise=(instance=this).item?onItemRefreshed.call(instance,instance.item):instance.getItem().then(onItemRefreshed.bind(instance)):(this.setTitle(),this.setTabs(),this.refreshItemPromise=Promise.resolve());var currentTabController=this.currentTabController;currentTabController&&currentTabController.onBeginResume&&currentTabController.onBeginResume(options)},TabbedView.prototype.onResume=function(options){BaseView.prototype.onResume.apply(this,arguments);var instance=this;userSettings.enableBackdrops()||backdrop.clear(),this.refreshItemPromise.then(function(){var currentTabController=instance.currentTabController;currentTabController&&currentTabController.onResume&&currentTabController.onResume(options)})},TabbedView.prototype.onPause=function(){BaseView.prototype.onPause.apply(this,arguments);var currentTabController=this.currentTabController;currentTabController&&currentTabController.onPause&&currentTabController.onPause()},TabbedView.prototype.setTitle=function(){appHeader.setTitle(this.getTitle())},TabbedView.prototype.getTitle=function(){return this.item||""},TabbedView.prototype.destroy=function(){var view=this.view,onInputCommandFn=this.onInputCommandFn;onInputCommandFn&&view&&inputManager.off(view,onInputCommandFn),this.onInputCommandFn=null,BaseView.prototype.destroy.apply(this,arguments);var tabControllers=this.tabControllers;tabControllers&&(tabControllers.forEach(function(t){t.destroy&&t.destroy()}),this.tabControllers=null),this.currentTabController=null,this.initialTabIndex=null,this.item=null},TabbedView});