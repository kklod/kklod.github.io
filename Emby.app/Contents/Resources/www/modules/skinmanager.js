define(["exports","./emby-apiclient/connectionmanager.js","./common/servicelocator.js","./common/usersettings/usersettings.js","./browser.js","./emby-apiclient/events.js","./backdrop/backdrop.js","./common/appsettings.js"],function(_exports,_connectionmanager,_servicelocator,_usersettings,_browser,_events,_backdrop,_appsettings){var themeStyleElement,currentThemeId,currentThemeSettings;function tryRemove(elem){try{elem.parentNode.removeChild(elem)}catch(err){console.log("Error removing child node: "+err)}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_connectionmanager=babelHelpers.interopRequireDefault(_connectionmanager),_usersettings=babelHelpers.interopRequireDefault(_usersettings),_browser=babelHelpers.interopRequireDefault(_browser),_events=babelHelpers.interopRequireDefault(_events),_backdrop=babelHelpers.interopRequireDefault(_backdrop),_appsettings=babelHelpers.interopRequireDefault(_appsettings);var supportsCssVariables=CSS.supports("color","var(--fake-var)");var defaultSettingsThemeIsMainTheme=_servicelocator.appHost.supports("multiserver");var skinManager={loadSkin:function(){return skinManager.setTheme(_usersettings.default.theme())},loadUserSkin:function(options){return skinManager.setTheme(_usersettings.default.theme()).then(function(){(options=options||{}).start?Emby.Page.invokeShortcut(options.start):Emby.Page.goHome()})},getThemes:function(){var defaultTheme="dark";return!_browser.default.tv&&!_browser.default.electron||_browser.default.tizen||(defaultTheme="blueradiance"),[{name:"Apple TV",id:"appletv"},{name:"Black",id:"black",isDefault:"black"===defaultTheme},{name:"Blue Radiance",id:"blueradiance",isDefault:"blueradiance"===defaultTheme},{name:"Dark",id:"dark",isDefault:"dark"===defaultTheme},{name:"Dark (red accent)",id:"dark-red"},{name:"Halloween",id:"halloween"},{name:"Holidays",id:"holiday"},{name:"Light",id:"light",isSettingsDefault:!defaultSettingsThemeIsMainTheme},{name:"Light (blue accent)",id:"light-blue"},{name:"Light (pink accent)",id:"light-pink"},{name:"Light (purple accent)",id:"light-purple"},{name:"Light (red accent)",id:"light-red"},{name:"Windows Media Center",id:"wmc"}]}};function onRegistrationSuccess(){_appsettings.default.set("appthemesregistered","true")}function onRegistrationFailure(){_appsettings.default.set("appthemesregistered","false")}function getThemeStylesheetInfo(id,isSettings,requiresRegistration){var apiClient;id||isSettings||((apiClient=_connectionmanager.default.currentApiClient())&&apiClient.getCurrentUserId()||(id=_appsettings.default.get("lastTheme")));for(var defaultMainTheme,defaultSettingsTheme,themes=skinManager.getThemes(),i=0,length=themes.length;i<length;i++){var theme=themes[i];theme.isDefault?defaultMainTheme=theme:theme.isSettingsDefault&&(defaultSettingsTheme=theme),id===theme.id&&(selectedTheme=theme)}defaultSettingsThemeIsMainTheme&&(defaultSettingsTheme=defaultMainTheme);var selectedTheme,defaultTheme=isSettings&&"maintheme"!==id?defaultSettingsTheme:defaultMainTheme;return(selectedTheme=selectedTheme||defaultTheme).id!==defaultTheme.id&&requiresRegistration&&(require(["registrationServices"]).then(function(deps){deps[0].validateFeature("themes",{showDialog:!1}).then(onRegistrationSuccess,onRegistrationFailure)}),"false"===_appsettings.default.get("appthemesregistered"))&&(selectedTheme=defaultTheme),{themeSettingsPath:"text!"+Emby.Page.baseUrl()+"/modules/themes/"+selectedTheme.id+"/theme.json",stylesheetPath:Emby.Page.baseUrl()+"/modules/themes/"+selectedTheme.id+"/theme.css",themeId:selectedTheme.id}}var themeResources={};var currentSound;var linkId=Date.now();skinManager.setTheme=function(id,context){return new Promise(function(resolve,reject){var newId,info,linkUrl,nextSibling,elem,link,elementId,requiresRegistration=!0,isSettings="settings"===context,updateLastTheme=!isSettings;isSettings||((newId=function(id){if(!_usersettings.default.enableSeasonalThemes())return id;var date=new Date,month=date.getMonth(),day=date.getDate();return 9===month&&31<=day?"halloween":11===month&&24<=day&&day<=25?"holiday":id}(id))!==id&&(requiresRegistration=!1),id=newId),"auto"===id&&_servicelocator.appHost.getPreferredTheme&&(id=_servicelocator.appHost.getPreferredTheme()||"dark",requiresRegistration=!1),currentThemeId&&currentThemeId===id?resolve():(info=getThemeStylesheetInfo(id,isSettings,requiresRegistration),currentThemeId&&currentThemeId===info.themeId?resolve():(linkUrl=info.stylesheetPath,(elem=themeStyleElement)&&(supportsCssVariables||_browser.default.netcast||(nextSibling=elem.nextSibling)&&nextSibling.getAttribute("data-cssvars-job")&&tryRemove(nextSibling),tryRemove(elem),currentThemeSettings=currentThemeId=themeStyleElement=null),link=document.createElement("link"),elementId="link_"+ ++linkId,link.id=elementId,link.setAttribute("rel","stylesheet"),link.setAttribute("type","text/css"),link.onload=function(){supportsCssVariables||_browser.default.netcast||function(elementId){require(["cssVars"],function(cssVars){cssVars({watch:!1,include:"#"+elementId,onlyLegacy:!1,preserveVars:!1,shadowDOM:!1})})}(elementId),function(themeInfo,updateLastTheme,resolveFn){document.documentElement.classList.remove("preload"),updateLastTheme&&_appsettings.default.set("lastTheme",themeInfo.themeId),require([themeInfo.themeSettingsPath],function(themeSettingsJson){currentThemeSettings=JSON.parse(themeSettingsJson);try{_servicelocator.appHost.setTheme(currentThemeSettings)}catch(err){console.log("Error setting theme color: "+err)}resolveFn()})}(info,updateLastTheme,resolve)},link.setAttribute("href",linkUrl),document.head.appendChild(link),themeStyleElement=link,currentThemeId=info.themeId,function(id){currentSound&&(currentSound.stop(),currentSound=null),_backdrop.default.clear(),themeResources="halloween"!==id?"holiday"!==id?{}:{backdrop:"https://github.com/MediaBrowser/Emby.Resources/raw/master/themes/holiday/bgc3.jpg"}:{backdrop:"https://github.com/MediaBrowser/Emby.Resources/raw/master/themes/halloween/bg.jpg"}}(info.themeId),loadThemeBackdrop(),document.removeEventListener("viewshow",onViewBeforeShow),themeResources.backdrop&&document.addEventListener("viewshow",onViewBeforeShow)))})};var currentThemeType,defaultLogoImageTypes=["Logo"];function loadThemeBackdrop(){themeResources.backdrop&&_backdrop.default.setBackdrop(themeResources.backdrop)}function onViewBeforeShow(e){e.detail&&"video-osd"===e.detail.type||loadThemeBackdrop()}function changeTheme(viewType){var context,mainTheme=_usersettings.default.theme();if(1===viewType){context="settings";var settingsTheme=_usersettings.default.settingsTheme();return!settingsTheme&&defaultSettingsThemeIsMainTheme&&(settingsTheme="maintheme"),"maintheme"===settingsTheme&&mainTheme&&(settingsTheme=mainTheme),void skinManager.setTheme(settingsTheme,context)}skinManager.setTheme(mainTheme,context)}skinManager.getPreferredLogoImageTypes=function(){return currentThemeSettings&&currentThemeSettings.preferredLogoImageTypes||defaultLogoImageTypes},document.addEventListener("viewbeforeshow",function(e){var viewType=e.detail.settingsTheme?1:0;viewType!==currentThemeType&&changeTheme(currentThemeType=viewType)}),_events.default.on(_usersettings.default,"change",function(e,name){"appTheme"!==name&&"settingsTheme"!==name||changeTheme(currentThemeType)}),_events.default.on(_connectionmanager.default,"localusersignedin",function(e){currentThemeType=null}),_exports.default=skinManager});