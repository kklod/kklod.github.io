define(["serverNotifications","events","loading","connectionManager","imageLoader","dom","globalize","layoutManager","listViewStyle"],function(serverNotifications,events,loading,connectionManager,imageLoader,dom,globalize,layoutManager){"use strict";function cancelJob(listInstance,id){require(["confirm"],function(confirm){confirm({text:globalize.translate("ConfirmRemoveDownload"),primary:"cancel"}).then(function(){loading.show();var apiClient=getApiClient(listInstance);apiClient.ajax({url:apiClient.getUrl("Sync/Jobs/"+id),type:"DELETE"}).then(function(){"download"===listInstance.options.mode&&require(["localsync"],function(localSync){localSync.sync()}),fetchData(listInstance)})})})}function refreshJob(listInstance,job){var listItem=listInstance.options.element.querySelector(".listItem[data-id='"+job.Id+"']");listItem&&(listItem.querySelector(".jobStatus").innerHTML=getProgressText(job))}function getProgressText(job){var status=job.Status;"Completed"===status&&(status="Synced");var progress,html=globalize.translate("SyncJobItemStatus"+status);return"Transferring"!==job.Status&&"Converting"!==job.Status||(html+=" ",0<(progress=job.Progress||0)&&progress<100&&(progress=progress.toFixed(1)),html+=progress+"%"),html}var supportsNativeLazyLoading="loading"in HTMLImageElement.prototype;function renderList(listInstance,jobs,apiClient){if(Date.now()-listInstance.lastDataLoad<6e4)!function(listInstance,jobs){for(var i=0,length=jobs.length;i<length;i++){refreshJob(listInstance,jobs[i])}}(listInstance,jobs);else{listInstance.lastDataLoad=Date.now();for(var html="",lastTargetName="",mode=listInstance.options.mode,showTargetName="download"!==mode,hasOpenSection=!1,i=0,length=jobs.length;i<length;i++){var targetName,job=jobs[i];!showTargetName||(targetName=job.TargetName||"Unknown")!==lastTargetName&&(lastTargetName&&(html+="</div>",html+="<br/>",hasOpenSection=!1),html+='<div class="verticalSection">',html+='<div class="sectionTitleContainer">',html+='<h2 class="sectionTitle">'+(lastTargetName=targetName)+"</h2>",html+="</div>",html+='<div class="itemsContainer vertical-list">',hasOpenSection=!0),html+=function(job,apiClient,mode){var imgUrl,html="",tagName=layoutManager.tv?"button":"div",typeAttribute="button"==tagName?' type="button"':"",listItemClass="listItem listItem-border";layoutManager.tv&&(listItemClass+=" listItem-button listItem-focusscale",listItemClass+=" btnJobMenu"),html+="<"+tagName+typeAttribute+' class="'+listItemClass+'" data-canedit="'+!0+'" data-id="'+job.Id+'" data-status="'+job.Status+'">',job.PrimaryImageItemId&&(imgUrl=apiClient.getImageUrl(job.PrimaryImageItemId,{type:"Primary",width:80,tag:job.PrimaryImageTag})),imgUrl?(html+='<div class="listItemImageContainer">',html+=supportsNativeLazyLoading?'<img class="listItemImage" loading="lazy" src="'+imgUrl+'" />':'<img class="listItemImage lazy" loading="lazy" src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=" data-src="'+imgUrl+'" />'):(html+='<div class="listItemImageContainer defaultCardBackground defaultCardBackground0">',html+="convert"===mode?'<i class="md-icon listItemIcon">transform</i>':'<i class="md-icon listItemIcon">download</i>'),html+="</div>";var textLines=[],name=job.Name;job.ParentName&&(name+=" - "+job.ParentName),textLines.push(name),1===job.ItemCount?textLines.push(globalize.translate("ValueOneItem")):textLines.push(globalize.translate("ItemCount",job.ItemCount)),html+='<div class="listItemBody three-line">';for(var i=0,length=textLines.length;i<length;i++)html+=0===i?'<div class="listItemBodyText">':'<div class="listItemBodyText listItemBodyText-secondary">',html+=textLines[i],html+="</div>";return html+='<div class="listItemBodyText-secondary listItemBodyText jobStatus">',html+=getProgressText(job),html+="</div>",html+="</div>",layoutManager.tv||(html+='<button type="button" is="paper-icon-button-light" class="btnJobMenu listItemButton"><i class="md-icon">more_horiz</i></button>'),html+="</"+tagName+">"}(job,apiClient,mode)}hasOpenSection&&(html+="</div>",html+="</div>");var elem=listInstance.options.element.querySelector(".syncJobListContent"),html=html||("download"===mode?'<div style="padding:1em .25em;">'+globalize.translate("MessageNoDownloadsFound")+"</div>":'<div style="padding:1em .25em;">'+globalize.translate("MessageNoSyncJobsFound")+"</div>");elem.innerHTML=html,imageLoader.lazyChildren(elem)}}function fetchData(listInstance){listInstance.lastDataLoad=0,loading.show();var options={},apiClient=getApiClient(listInstance);return listInstance.options.userId&&(options.UserId=listInstance.options.userId),"download"===listInstance.options.mode?options.TargetId=apiClient.deviceId():"convert"===listInstance.options.mode?options.IncludeProviders="ConvertSyncProvider":options.ExcludeProviders="ConvertSyncProvider",apiClient.getJSON(apiClient.getUrl("Sync/Jobs",options)).then(function(response){renderList(listInstance,response.Items,apiClient),loading.hide()})}function getApiClient(listInstance){return connectionManager.getApiClient(listInstance.options.serverId)}function onElementClick(e){var btnCancelJob,listItem,btnJobMenu=e.target.closest(".btnJobMenu");btnJobMenu?function(listInstance,elem){var item=elem.closest(".listItem"),jobId=item.getAttribute("data-id"),menuItems=[];"true"===item.getAttribute("data-canedit")&&menuItems.push({name:globalize.translate("Edit"),id:"edit"});var txt=globalize.translate("RemoveDownload");menuItems.push({name:txt,id:"cancel"}),require(["actionsheet"],function(actionsheet){actionsheet.show({items:menuItems,positionTo:elem,callback:function(id){switch(id){case"delete":case"cancel":cancelJob(listInstance,jobId);break;case"edit":showJobEditor(listInstance,elem)}}})})}(this,btnJobMenu):(btnCancelJob=e.target.closest(".btnCancelJob"))?(listItem=btnCancelJob.closest(".listItem"))&&cancelJob(this,listItem.getAttribute("data-id")):showJobEditor(this,e.target)}function showJobEditor(listInstance,elem){var jobId,listItem=elem.closest(".listItem");listItem&&"true"===listItem.getAttribute("data-canedit")&&(jobId=listItem.getAttribute("data-id"),require(["syncJobEditor"],function(syncJobEditor){syncJobEditor.show({serverId:listInstance.options.serverId,jobId:jobId,mode:listInstance.options.mode}).then(function(){fetchData(listInstance)},function(){fetchData(listInstance)})}))}function syncJobList(options){this.options=options;var onSyncJobCreatedHandler=function(e,apiClient,data){fetchData(this)}.bind(this);this.onSyncJobCreatedHandler=onSyncJobCreatedHandler,events.on(serverNotifications,"SyncJobCreated",onSyncJobCreatedHandler);var onSyncJobCancelledHandler=function(e,apiClient,data){fetchData(this)}.bind(this);this.onSyncJobCancelledHandler=onSyncJobCancelledHandler,events.on(serverNotifications,"SyncJobCancelled",onSyncJobCancelledHandler);var onSyncJobUpdatedHandler=function(e,apiClient,data){refreshJob(this,data)}.bind(this);this.onSyncJobUpdatedHandler=onSyncJobUpdatedHandler,events.on(serverNotifications,"SyncJobUpdated",onSyncJobUpdatedHandler);var onClickHandler=onElementClick.bind(this);options.element.addEventListener("click",onClickHandler),this.onClickHandler=onClickHandler,options.element.innerHTML='<div class="syncJobListContent"></div>',fetchData(this)}return syncJobList.prototype.destroy=function(){var onSyncJobCreatedHandler=this.onSyncJobCreatedHandler;this.onSyncJobCreatedHandler=null,events.off(serverNotifications,"SyncJobCreated",onSyncJobCreatedHandler);var onSyncJobCancelledHandler=this.onSyncJobCancelledHandler;this.onSyncJobCancelledHandler=null,events.off(serverNotifications,"SyncJobCancelled",onSyncJobCancelledHandler);var onSyncJobUpdatedHandler=this.onSyncJobUpdatedHandler;this.onSyncJobUpdatedHandler=null,events.off(serverNotifications,"SyncJobUpdated",onSyncJobUpdatedHandler);var onClickHandler=this.onClickHandler;this.onClickHandler=null,this.options.element.removeEventListener("click",onClickHandler),this.options=null},syncJobList});